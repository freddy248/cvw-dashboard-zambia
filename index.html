<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>CVW Dashboard - Zambia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            max-width: 400px;
            margin: 10vh auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            text-align: center;
        }

        .login-title {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .demo-accounts {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .account-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            padding: 30px;
            border-bottom: 2px solid #667eea;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .user-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .section {
            background: white;
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-content {
            padding: 30px;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .agency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .agency-card {
            background: #f8f9fa;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .agency-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .agency-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .agency-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .agency-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .agency-code {
            background: rgba(0, 0, 0, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .agency-display {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .kpi-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .filter-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-victim {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-witness {
            background: #dbeafe;
            color: #2563eb;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification.success {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #10b981;
        }

        .notification.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .notification.info {
            background: #dbeafe;
            color: #2563eb;
            border: 1px solid #3b82f6;
        }

        .statistics-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .stats-label {
            font-weight: 600;
            color: #495057;
        }

        .stats-value {
            color: #2c3e50;
            font-weight: bold;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex !important;
        }

        .modal-container {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .agency-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
        }

        .agency-info {
            flex: 1;
        }

        .agency-code-display {
            font-weight: bold;
            color: #2c3e50;
            font-family: monospace;
        }

        .agency-name-display {
            color: #6c757d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .agency-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBo0jRzfh3DVNdCkPjXXgwvi2cfacXE1Ok",
    authDomain: "cvw-dashboard-zambia.firebaseapp.com",
    projectId: "cvw-dashboard-zambia",
    storageBucket: "cvw-dashboard-zambia.appspot.com",
    messagingSenderId: "905368303709",
    appId: "1:905368303709:web:e71f7abc063e78224b35b4"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>
</head>
<body>
<!-- Admin Panel (hidden for non-admins) -->
<div id="adminPanel" style="display:none;">
<h2>Admin Panel</h2>
<button onclick="openAddUserModal()">Add User</button>
<button id="manageAgenciesBtn" onclick="openAgencyModal()">Manage Agencies</button>
</div>
<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
<h1 class="login-title">üìä CVW Dashboard</h1>
<p class="login-subtitle">Zambia Child Victim &amp; Witness Analytics</p>
<div class="notification error" id="loginError" style="position: static; display: none; margin-bottom: 20px;">
            Invalid credentials
        </div>
<div id="loginForm">
<div class="form-group">
<input class="form-input" id="username" placeholder="Username" required="" type="text"/>
</div>
<div class="form-group">
<input class="form-input" id="password" placeholder="Password" required="" type="password"/>
</div>
<button class="btn btn-primary" onclick="handleLogin()" type="button">üöÄ Login</button>
</div>
<div class="demo-accounts">
<h3 style="margin-bottom: 15px; color: #2c3e50;">Demo Accounts</h3>
<div class="account-row">
<span><strong>Admin:</strong> admin / admin123</span>
<button class="btn btn-sm btn-success" onclick="fillLogin('admin', 'admin123')">Fill</button>
</div>
<div class="account-row">
<span><strong>Viewer:</strong> viewer / view123</span>
<button class="btn btn-sm btn-info" onclick="fillLogin('viewer', 'view123')">Fill</button>
</div>
<div class="account-row">
<span><strong>General Reporter:</strong> reporter / report123</span>
<button class="btn btn-sm btn-warning" onclick="fillLogin('reporter', 'report123')">Fill</button>
</div>
<div class="account-row">
<span><strong>NPA Reporter:</strong> npa_reporter / npa_reporter</span>
<button class="btn btn-sm" onclick="fillLogin('npa_reporter', 'npa_reporter')" style="background: #6f42c1; color: white;">Fill</button>
</div>
<div class="account-row">
<span><strong>MOH Reporter:</strong> moh_reporter / moh_reporter</span>
<button class="btn btn-sm" onclick="fillLogin('moh_reporter', 'moh_reporter')" style="background: #e83e8c; color: white;">Fill</button>
</div>
<div class="account-row">
<span><strong>ZP Reporter:</strong> zp_reporter / zp_reporter</span>
<button class="btn btn-sm" onclick="fillLogin('zp_reporter', 'zp_reporter')" style="background: #20c997; color: white;">Fill</button>
</div>
</div>
</div>
<!-- Main Dashboard -->
<div class="container hidden" id="mainDashboard">
<!-- User Bar -->
<div class="user-bar">
<div class="user-info">
<div class="user-avatar" id="userAvatar">A</div>
<div>
<div id="userName" style="font-weight: 600; color: #2c3e50;">Administrator</div>
<div id="userRole" style="font-size: 0.9rem; color: #7f8c8d;">Admin Account</div>
</div>
</div>
<button class="btn" onclick="logout()" style="background: #dc3545; color: white;">üö™ Logout</button>
</div>
<!-- Header -->
<div class="dashboard">
<div class="header">
<h1>üìä CVW Analytics Dashboard</h1>
<p style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin: 10px 0;">ZAMBIA</p>
<p class="subtitle">Child Victim &amp; Witness Case Management System</p>
</div>
</div>
<!-- Dashboard Controls Section (Admin Only) -->
<div class="section" id="dashboardControlsSection">
<div class="section-header">üéõÔ∏è Dashboard Controls</div>
<div class="section-content">
<div class="action-grid">
<button class="btn btn-success" onclick="openAddRecord()">‚ûï Add New Record</button>
<button class="btn btn-info" onclick="toggleSearch()">üîç Search Records</button>
<button class="btn" onclick="exportPDF()" style="background: #dc3545; color: white;">üìÑ Export PDF</button>
<button class="btn" onclick="exportCSV()" style="background: #28a745; color: white;">üìä Export CSV</button>
<button class="btn" onclick="manageUsers()" style="background: #6f42c1; color: white;">üë• Manage Users</button>
<button class="btn" onclick="manageAgencies()" style="background: #fd7e14; color: white;">üè¢ Manage Agencies</button>
</div>
</div>
</div>
<!-- Export & Reports Section (Viewer Only) -->
<div class="section hidden" id="exportReportsSection">
<div class="section-header">üì§ Export &amp; Reports</div>
<div class="section-content">
<div class="action-grid">
<button class="btn" onclick="exportPDF()" style="background: #dc3545; color: white;">üìÑ Export PDF</button>
<button class="btn" onclick="exportCSV()" style="background: #28a745; color: white;">üìä Export CSV</button>
</div>
</div>
</div>
<!-- Search Section -->
<div class="section hidden" id="searchSection">
<div class="section-header">üîç Case Search</div>
<div class="section-content">
<div class="search-box">
<input class="search-input" id="searchInput" placeholder="Enter Case ID (e.g., NPA-CV1, MOH-CW5) or search by district, crime type" type="text"/>
<button class="btn btn-primary" onclick="searchRecords()">Search</button>
<button class="btn" onclick="clearSearch()" style="background: #6c757d; color: white;">Clear</button>
</div>
<div class="search-results" id="searchResults"></div>
</div>
</div>
<!-- Add New Record Modal -->
<div class="modal-overlay" id="addRecordModal" style="display: none;">
<div class="modal-container" style="max-width: 900px;">
<div class="modal-header">
<h2>Add New Case Record</h2>
<button class="modal-close" onclick="closeAddRecordModal()">√ó</button>
</div>
<div class="modal-body">
<div class="success-message" id="successMessage" style="background: #d1fae5; color: #059669; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981; display: none;">
                        Record added successfully!
                    </div>
<div class="error-message" id="errorMessage" style="background: #fee2e2; color: #dc2626; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444; display: none;">
                        Please fill in all required fields.
                    </div>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Case ID</label>
<input id="modalCaseId" placeholder="Auto-generated if empty" readonly="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
<small style="color: #666; margin-top: 5px; display: block;">Will be auto-generated based on record type</small>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Record Type *</label>
<select id="modalRecordType" onchange="generateModalCaseId()" required="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Type</option>
<option value="Victim">Victim</option>
<option value="Witness">Witness</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Date Reported *</label>
<input id="modalDateReported" required="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="date"/>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">District *</label>
<select id="modalDistrict" required="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select District</option>
<option value="Lusaka">Lusaka</option>
<option value="Kitwe">Kitwe</option>
<option value="Ndola">Ndola</option>
<option value="Kabwe">Kabwe</option>
<option value="Chingola">Chingola</option>
<option value="Mufulira">Mufulira</option>
<option value="Livingstone">Livingstone</option>
<option value="Luanshya">Luanshya</option>
<option value="Kasama">Kasama</option>
<option value="Chipata">Chipata</option>
<option value="Katete">Katete</option>
<option value="Solwezi">Solwezi</option>
<option value="Mongu">Mongu</option>
<option value="Mazabuka">Mazabuka</option>
<option value="Monze">Monze</option>
<option value="Mansa">Mansa</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">CVW Gender *</label>
<select id="modalCvwGender" required="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Gender</option>
<option value="MALE">Male</option>
<option value="FEMALE">Female</option>
</select>
</div>
<!-- Enhanced CVW Age Input with Years/Months -->
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">CVW Age *</label>
<div style="display: flex; gap: 10px; align-items: center;">
<input id="modalCvwAge" max="120" min="0" placeholder="Enter age" required="" style="flex: 2; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="number"/>
<select id="modalAgeUnit" required="" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Unit</option>
<option value="years">Years</option>
<option value="months">Months</option>
</select>
</div>
<small style="color: #666; font-size: 0.8rem; margin-top: 5px; font-style: italic; display: block;">
                                Select <strong>months</strong> for infants under 1 year, <strong>years</strong> for children 1+ years old
                            </small>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Offender Gender</label>
<select id="modalOffenderGender" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Gender</option>
<option value="MALE">Male</option>
<option value="FEMALE">Female</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Offender Age</label>
<input id="modalOffenderAge" min="0" placeholder="Offender Age" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="number"/>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Crime Type *</label>
<select id="modalCrimeType" required="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Crime Type</option>
<option value="ASSAULT ON A CHILD">Assault on a Child</option>
<option value="PHYSICAL ABUSE">Physical Abuse</option>
<option value="SEXUAL ASSAULT">Sexual Assault</option>
<option value="RAPE">Rape</option>
<option value="CHILD NEGLECT">Child Neglect</option>
<option value="DEFILEMENT">Defilement</option>
<option value="ONLINE SEXUAL EXPLOITATION">Online Sexual Exploitation</option>
<option value="TRAFFICKING">Trafficking</option>
<option value="NEGLECT">Neglect</option>
<option value="EXPLOITATION">Exploitation</option>
<option value="DOMESTIC VIOLENCE">Domestic Violence</option>
<option value="OTHER">Other</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Disability</label>
<select id="modalDisability" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="NON">None</option>
<option value="PHYSICAL">Physical</option>
<option value="MENTAL">Mental</option>
<option value="MENTAL+PHYSICAL">Mental + Physical</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Services Rendered</label>
<select id="modalServicesRendered" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Services</option>
<option value="MEDICAL REPORT">Medical Report</option>
<option value="COUNSELLING">Counselling</option>
<option value="LEGAL AID">Legal Aid</option>
<option value="PSYCHOSOCIAL SUPPORT">Psychosocial Support</option>
<option value="SHELTER">Shelter</option>
<option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
<option value="LEGAL + COUNSELLING">Legal + Counselling</option>
<option value="REFERRAL">Referral</option>
<option value="FOLLOW-UP">Follow-up</option>
<option value="REHABILITATION">Rehabilitation</option>
<option value="FAMILY SUPPORT">Family Support</option>
<option value="EMERGENCY CARE">Emergency Care</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Relationship to CV</label>
<select id="modalRelationshipToCv" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Relationship</option>
<option value="STRANGER">Stranger</option>
<option value="FRIEND">Friend</option>
<option value="FATHER">Father</option>
<option value="MOTHER">Mother</option>
<option value="LANDLORD">Landlord</option>
<option value="NEIGHBOR">Neighbor</option>
<option value="RELATIVE">Relative</option>
<option value="TEACHER">Teacher</option>
<option value="CAREGIVER">Caregiver</option>
</select>
</div>
</div>
<div class="form-group" style="margin-top: 20px;">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Additional Notes (Optional)</label>
<textarea id="modalAdditionalNotes" placeholder="Any additional information about the case..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;"></textarea>
</div>
</div>
<div style="padding: 20px 30px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 15px;">
<button class="btn" onclick="closeAddRecordModal()" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;" type="button">Cancel</button>
<button class="btn btn-primary" onclick="saveNewRecord()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;" type="button">Save Record</button>
</div>
</div>
</div>
<!-- Update Services Modal -->
<div class="modal-overlay" id="updateServicesModal" style="display: none;">
<div class="modal-container" style="max-width: 600px;">
<div class="modal-header">
<h2>Update Services</h2>
<button class="modal-close" onclick="closeUpdateServicesModal()">√ó</button>
</div>
<div class="modal-body">
<div class="statistics-summary" id="currentCaseInfo" style="margin-bottom: 20px;">
<h4 style="margin-bottom: 15px; color: #2c3e50;">Case Information</h4>
<div class="stats-row">
<span class="stats-label">Case ID:</span>
<span class="stats-value" id="updateCaseId">-</span>
</div>
<div class="stats-row">
<span class="stats-label">Current Services:</span>
<span class="stats-value" id="updateCurrentServices">-</span>
</div>
<div class="stats-row">
<span class="stats-label">Your Agency:</span>
<span class="stats-value" id="updateAgencyName">-</span>
</div>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Additional Service to Add *</label>
<select id="additionalService" required="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Additional Service</option>
<option value="MEDICAL REPORT">Medical Report</option>
<option value="COUNSELLING">Counselling</option>
<option value="LEGAL AID">Legal Aid</option>
<option value="PSYCHOSOCIAL SUPPORT">Psychosocial Support</option>
<option value="SHELTER">Shelter</option>
<option value="REFERRAL">Referral</option>
<option value="FOLLOW-UP">Follow-up</option>
<option value="REHABILITATION">Rehabilitation</option>
<option value="FAMILY SUPPORT">Family Support</option>
<option value="EMERGENCY CARE">Emergency Care</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Service Notes (Optional)</label>
<textarea id="serviceNotes" placeholder="Additional details about the service provided..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;"></textarea>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Service Date *</label>
<input id="serviceDate" required="" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="date"/>
</div>
</div>
<div style="padding: 20px 30px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 15px;">
<button class="btn" onclick="closeUpdateServicesModal()" style="background: #6c757d; color: white;" type="button">Cancel</button>
<button class="btn btn-primary" onclick="saveUpdatedServices()" type="button">Update Services</button>
</div>
</div>
</div>
<!-- User Management Modal -->
<div class="modal-overlay" id="userMgmtModal" style="display: none;">
<div class="modal-container" style="max-width: 600px;">
<div class="modal-header">
<h2>üë• User Management</h2>
<button class="modal-close" onclick="closeUserMgmtModal()">√ó</button>
</div>
<div class="modal-body">
<div style="margin-bottom: 30px;">
<h3 style="margin-bottom: 15px; color: #2c3e50;">Add New User</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Username</label>
<input id="newUsername" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Password</label>
<input id="newPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="password"/>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Role</label>
<select id="newUserRole" onchange="toggleAgencySelection()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">Select Role</option>
<option value="admin">Admin</option>
<option value="viewer">Viewer</option>
<option value="reporter">Reporter</option>
</select>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Full Name</label>
<input id="newUserName" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
</div>
</div>
<div class="form-group" id="agencySelectionGroup" style="display: none;">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Agency (Optional for Reporters)</label>
<select id="newUserAgency" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
<option value="">No specific agency (General Reporter)</option>
</select>
</div>
<button class="btn btn-success" onclick="addNewUser()">+ Add User</button>
</div>
<div>
<h3 style="margin-bottom: 15px; color: #2c3e50;">Existing Users</h3>
<div id="usersList" style="max-height: 300px; overflow-y: auto;"></div>
</div>
</div>
</div>
</div>
<!-- Agency Management Modal -->
<div class="modal-overlay" id="agencyModal" style="display: none;">
<div class="modal-container" style="max-width: 700px;">
<div class="modal-header">
<h2>üè¢ Manage Agencies</h2>
<button class="modal-close" onclick="closeAgencyModal()">√ó</button>
</div>
<div class="modal-body">
<div style="margin-bottom: 30px;">
<h3 style="margin-bottom: 15px; color: #2c3e50;">Add New Agency</h3>
<div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: end;">
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Agency Code</label>
<input id="newAgencyCode" maxlength="5" placeholder="e.g., EDU" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
</div>
<div class="form-group">
<label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Agency Name</label>
<input id="newAgencyName" placeholder="e.g., Ministry of Education" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
</div>
<button class="btn btn-success" onclick="addAgency()" style="height: 48px;">+ Add Agency</button>
</div>
</div>
<div>
<h3 style="margin-bottom: 15px; color: #2c3e50;">Current Agencies</h3>
<div id="agencyList" style="max-height: 400px; overflow-y: auto;"></div>
</div>
</div>
</div>
</div>
<!-- Filters Section -->
<div class="section" id="filtersSection">
<div class="section-header">üîß Data Filters</div>
<div class="section-content">
<div class="filters-grid">
<div class="filter-group">
<label class="filter-label">District</label>
<select class="filter-select" id="districtFilter" onchange="applyFilters()">
<option value="">All Districts</option>
<option value="Lusaka">Lusaka</option>
<option value="Ndola">Ndola</option>
<option value="Kitwe">Kitwe</option>
<option value="Livingstone">Livingstone</option>
<option value="Katete">Katete</option>
<option value="Kabwe">Kabwe</option>
<option value="Chingola">Chingola</option>
<option value="Mufulira">Mufulira</option>
<option value="Luanshya">Luanshya</option>
<option value="Kasama">Kasama</option>
<option value="Chipata">Chipata</option>
<option value="Solwezi">Solwezi</option>
<option value="Mongu">Mongu</option>
<option value="Mazabuka">Mazabuka</option>
<option value="Monze">Monze</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">Record Type</label>
<select class="filter-select" id="recordTypeFilter" onchange="applyFilters()">
<option value="">All Types</option>
<option value="Victim">Victim</option>
<option value="Witness">Witness</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">Crime Type</label>
<select class="filter-select" id="crimeTypeFilter" onchange="applyFilters()">
<option value="">All Crime Types</option>
<option value="RAPE">Rape</option>
<option value="DEFILEMENT">Defilement</option>
<option value="ASSAULT ON A CHILD">Assault on a Child</option>
<option value="CHILD ABUSE">Child Abuse</option>
<option value="TRAFFICKING">Trafficking</option>
<option value="NEGLECT">Neglect</option>
<option value="EXPLOITATION">Exploitation</option>
<option value="DOMESTIC VIOLENCE">Domestic Violence</option>
<option value="OTHER">Other</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">Gender</label>
<select class="filter-select" id="genderFilter" onchange="applyFilters()">
<option value="">All Genders</option>
<option value="MALE">Male</option>
<option value="FEMALE">Female</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">Age Range</label>
<select class="filter-select" id="ageRangeFilter" onchange="applyFilters()">
<option value="">All Ages</option>
<option value="0-5">0-5 years</option>
<option value="6-10">6-10 years</option>
<option value="11-15">11-15 years</option>
<option value="16-18">16-18 years</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">Date Range</label>
<select class="filter-select" id="dateRangeFilter" onchange="applyFilters()">
<option value="">All Dates</option>
<option value="last7days">Last 7 days</option>
<option value="last30days">Last 30 days</option>
<option value="last3months">Last 3 months</option>
<option value="last6months">Last 6 months</option>
<option value="thisyear">This year</option>
</select>
</div>
</div>
<div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
<button class="btn" onclick="resetFilters()" style="background: #ffc107; color: #000;">üîÑ Reset All</button>
<button class="btn" onclick="exportFilteredData()" style="background: #28a745; color: white;">üìä Export Filtered Data</button>
</div>
<!-- Filter Results Summary -->
<div class="statistics-summary" id="filterSummary" style="margin-top: 20px; display: none;">
<h4 style="margin-bottom: 15px; color: #2c3e50;">üéØ Filter Results</h4>
<div class="stats-row">
<span class="stats-label">Active Filters:</span>
<span class="stats-value" id="activeFilters">None</span>
</div>
<div class="stats-row">
<span class="stats-label">Records Shown:</span>
<span class="stats-value" id="filteredCount">0</span>
</div>
<div class="stats-row">
<span class="stats-label">Total Records:</span>
<span class="stats-value" id="totalCount">0</span>
</div>
</div>
</div>
</div>
<!-- Agency Section (Reporter Only) -->
<div class="section" id="agencySection">
<div class="section-header">Agency Selection</div>
<div class="section-content">
<div class="agency-grid" id="agencyGridContainer">
<!-- Dynamic agency cards will be populated here -->
</div>
</div>
</div>
<!-- Reporter Actions Section -->
<div class="section hidden" id="reporterActionsSection">
<div class="section-header">Reporter Actions</div>
<div class="section-content">
<div class="statistics-summary" id="selectedAgencyInfo" style="margin-bottom: 20px;">
<div class="stats-row">
<span class="stats-label">Selected Agency:</span>
<span class="stats-value" id="currentAgencyName">Not Selected</span>
</div>
<div class="stats-row">
<span class="stats-label">Agency Code:</span>
<span class="stats-value" id="currentAgencyCode">N/A</span>
</div>
</div>
<div class="action-grid">
<button class="btn btn-success" id="reporterAddBtn" onclick="openAddRecord()">‚ûï Add New Record</button>
<button class="btn btn-info" onclick="toggleSearch()">üîç Search Records</button>
</div>
</div>
</div>
<!-- KPI Cards -->
<div class="section" id="kpiSection">
<div class="section-header">üìä Key Performance Indicators</div>
<div class="section-content">
<div class="kpi-grid">
<div class="kpi-card">
<div class="kpi-value" id="totalCases">6</div>
<div class="kpi-label">Total Cases</div>
</div>
<div class="kpi-card">
<div class="kpi-value" id="victimCases">4</div>
<div class="kpi-label">Victim Cases</div>
</div>
<div class="kpi-card">
<div class="kpi-value" id="witnessCases">2</div>
<div class="kpi-label">Witness Cases</div>
</div>
<div class="kpi-card">
<div class="kpi-value" id="avgAge">10.5</div>
<div class="kpi-label">Average Age</div>
</div>
</div>
<!-- Statistics Summary -->
<div class="statistics-summary">
<h4 style="margin-bottom: 15px; color: #2c3e50;">üìà Summary Statistics</h4>
<div class="stats-row">
<span class="stats-label">Most Affected District:</span>
<span class="stats-value" id="topDistrict">Lusaka</span>
</div>
<div class="stats-row">
<span class="stats-label">Most Common Crime:</span>
<span class="stats-value" id="topCrime">Rape</span>
</div>
<div class="stats-row">
<span class="stats-label">Most Common Service:</span>
<span class="stats-value" id="topService">Medical Report</span>
</div>
<div class="stats-row">
<span class="stats-label">Female Cases:</span>
<span class="stats-value" id="femaleCases">3 (50%)</span>
</div>
<div class="stats-row">
<span class="stats-label">Male Cases:</span>
<span class="stats-value" id="maleCases">3 (50%)</span>
</div>
</div>
</div>
</div>
<!-- Charts -->
<div class="section" id="chartsSection">
<div class="section-header">üìà Analytics Charts</div>
<div class="section-content">
<div class="charts-grid">
<div class="chart-card">
<div class="chart-title">Cases by District</div>
<div class="chart-canvas">
<canvas id="districtChart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-title">Crime Types</div>
<div class="chart-canvas">
<canvas id="crimeChart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-title">Age Distribution</div>
<div class="chart-canvas">
<canvas id="ageChart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-title">Gender Distribution</div>
<div class="chart-canvas">
<canvas id="genderChart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-title">Cases Over Time</div>
<div class="chart-canvas">
<canvas id="timeChart"></canvas>
</div>
</div>
<div class="chart-card">
<div class="chart-title">Services Rendered</div>
<div class="chart-canvas">
<canvas id="servicesChart"></canvas>
</div>
</div>
</div>
</div>
</div>
<!-- Data Table -->
<div class="section" id="tableSection">
<div class="section-header">üìã Case Records</div>
<div class="section-content">
<div class="table-wrapper">
<table class="data-table">
<thead>
<tr>
<th>Case ID</th>
<th>Type</th>
<th>Date</th>
<th>District</th>
<th>Gender</th>
<th>Age</th>
<th>Crime Type</th>
<th>Services</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>
</div>
</div>
<div class="notification" id="notification"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
// === Sync History Logger ===
function logSyncEvent(action, itemType, details) {
  let history = JSON.parse(localStorage.getItem("syncHistory") || "[]");
  history.push({
    action,
    type: itemType,
    details,
    time: new Date().toLocaleString()
  });
  localStorage.setItem("syncHistory", JSON.stringify(history));
}

// === Offline Sync ===
window.addEventListener("online", () => {
  const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
  if (queue.length > 0) {
    queue.forEach(item => {
      if (item.type === "case") {
        db.collection("cases").doc(item.record['cvw code']).set(item.record);
        logSyncEvent('synced','case',item.record['cvw code']);
      }
      if (item.type === "user") {
        db.collection("users").doc(item.userId).set(item.profile);
        logSyncEvent('synced','user',item.userId);
      }
    });
    localStorage.removeItem("offlineQueue");
    showNotification("Offline data synced with Firebase!", "success");
  }
});

// === Persistence Helpers ===
function saveRecordToFirestore(record) {
  return db.collection("cases").doc(record['cvw code']).set(record)
    .then(() => {
      console.log("Saved to Firestore:", record['cvw code']);
      // Also update localStorage
      const stored = JSON.parse(localStorage.getItem("cases") || "[]");
      stored.push(record);
      localStorage.setItem("cases", JSON.stringify(stored));
    })
    .catch(err => {
      console.error("Firestore save error", err);
      showNotification("Failed to save record to Firebase: " + err.message, "error");
    });
}

function loadRecordsFromPersistence(callback) {
  db.collection("cases").get().then(snapshot => {
    let cases = snapshot.docs.map(doc => doc.data());
    if (cases.length === 0) {
      cases = JSON.parse(localStorage.getItem("cases") || "[]");
    }
    callback(cases);
  }).catch(err => {
    console.error("Error loading Firestore:", err);
    const cases = JSON.parse(localStorage.getItem("cases") || "[]");
    callback(cases);
  });
}

function saveUserToFirestore(uid, profile) {
  return db.collection("users").doc(uid).set(profile);
}

function loadUserProfile(uid) {
  return db.collection("users").doc(uid).get().then(doc => doc.data());
}


        // Global variables
        let currentUser = null;
        let selectedAgency = null;
        let allData = [];
        let filteredData = [];
        let charts = {};
        
        // Enhanced agencies array - now dynamic
        let agencies = [
            { code: 'NPA', name: 'National Prosecution Authority', icon: '‚öñÔ∏è' },
            { code: 'ZP',  name: 'Zambia Police', icon: 'üëÆ' },
            { code: 'MOH', name: 'Ministry of Health', icon: 'üè•' }
        ];

        // User accounts
        const users = {
            'admin': { password: 'admin123', role: 'admin', name: 'Administrator', avatar: 'A' },
            'viewer': { password: 'view123', role: 'viewer', name: 'Data Viewer', avatar: 'V' },
            'reporter': { password: 'report123', role: 'reporter', name: 'Case Reporter', avatar: 'R' },
            'npa_reporter': { password: 'npa_reporter', role: 'reporter', name: 'NPA Reporter', avatar: 'N', agency: 'NPA' },
            'moh_reporter': { password: 'moh_reporter', role: 'reporter', name: 'MOH Reporter', avatar: 'M', agency: 'MOH' },
            'zp_reporter': { password: 'zp_reporter', role: 'reporter', name: 'ZP Reporter', avatar: 'Z', agency: 'ZP' }
        };

        // Sample data
        const sampleData = [
            {
                'cvw code': 'NPA-CV1',
                'Record Type': 'Victim',
                'Date Reported': new Date('2025-01-04'),
                'District': 'Lusaka',
                'CVW Gender': 'MALE',
                'CVW Age': 5,
                'Crime Type': 'ASSAULT ON A CHILD',
                'Services Rendered': 'MEDICAL REPORT'
            },
            {
                'cvw code': 'MOH-CW5',
                'Record Type': 'Witness',
                'Date Reported': new Date('2025-02-07'),
                'District': 'Katete',
                'CVW Gender': 'MALE',
                'CVW Age': 15,
                'Crime Type': 'RAPE',
                'Services Rendered': 'COUNSELLING'
            },
            {
                'cvw code': 'ZP-CV4',
                'Record Type': 'Victim',
                'Date Reported': new Date('2025-03-11'),
                'District': 'Lusaka',
                'CVW Gender': 'FEMALE',
                'CVW Age': 12,
                'Crime Type': 'RAPE',
                'Services Rendered': 'MEDICAL + COUNSELLING'
            },
            {
                'cvw code': 'NPA-CV2',
                'Record Type': 'Victim',
                'Date Reported': new Date('2025-01-15'),
                'District': 'Ndola',
                'CVW Gender': 'FEMALE',
                'CVW Age': 8,
                'Crime Type': 'DEFILEMENT',
                'Services Rendered': 'LEGAL AID'
            },
            {
                'cvw code': 'MOH-CW3',
                'Record Type': 'Witness',
                'Date Reported': new Date('2025-02-20'),
                'District': 'Kitwe',
                'CVW Gender': 'MALE',
                'CVW Age': 10,
                'Crime Type': 'CHILD ABUSE',
                'Services Rendered': 'PSYCHOSOCIAL SUPPORT'
            },
            {
                'cvw code': 'ZP-CV6',
                'Record Type': 'Victim',
                'Date Reported': new Date('2025-03-01'),
                'District': 'Livingstone',
                'CVW Gender': 'FEMALE',
                'CVW Age': 14,
                'Crime Type': 'TRAFFICKING',
                'Services Rendered': 'SHELTER'
            }
        ];

        // Chart colors
        const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];

        // Agency Management Functions
        window.manageAgencies = function() {
            console.log('Opening agency management...');
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Access denied: Only administrators can manage agencies', 'error');
                return;
            }
            
            const modal = document.getElementById('agencyModal');
            modal.classList.remove('hidden');
            modal.classList.add('active');
            updateAgencyList();
        };

        window.closeAgencyModal = function() {
            console.log('Closing agency management modal');
            const modal = document.getElementById('agencyModal');
            modal.classList.remove('active');
            modal.classList.add('hidden');
        };

        window.addAgency = function() {
  const agencyCode = document.getElementById('newAgencyCode').value.trim().toUpperCase();
  const agencyName = document.getElementById('newAgencyName').value.trim();

  if (!agencyCode || !agencyName) {
    showNotification("Please fill in all agency fields", "error");
    return;
  }

  if (navigator.onLine && !currentUser.offline) {
    db.collection("agencies").doc(agencyCode).set({ code: agencyCode, name: agencyName })
      .then(() => {
        showNotification(`Agency ${agencyName} created successfully`, "success");
        updateAgenciesList();
      })
      .catch(err => {
        showNotification("Error creating agency: " + err.message, "error");
      });
  } else {
    let offlineQueue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
    offlineQueue.push({ type: "agency", code: agencyCode, name: agencyName });
    logSyncEvent('queued','agency',agencyCode);
    localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
    showNotification(`Agency ${agencyName} saved offline and will sync later.`, "warning");
  }
};

            agencies.push(newAgency);
            
            // Update displays
            updateAgencyList();
            updateAgencyGrid();
            updateUserAgencyDropdown();
            
            // Clear form
            document.getElementById('newAgencyCode').value = '';
            document.getElementById('newAgencyName').value = '';
            
            showNotification(`Agency "${code} - ${name}" added successfully`, 'success');
        };

        window.deleteAgency = function(agencyCode) {
            console.log('Deleting agency:', agencyCode);
            
            // Prevent deletion of core agencies
            const coreAgencies = ['NPA', 'MOH', 'ZP'];
            if (coreAgencies.includes(agencyCode)) {
                showNotification('Cannot delete core agencies (NPA, MOH, ZP)', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete agency "${agencyCode}"?\n\nThis action cannot be undone and may affect existing records.`)) {
                const agencyIndex = agencies.findIndex(agency => agency.code === agencyCode);
                if (agencyIndex !== -1) {
                    const deletedAgency = agencies[agencyIndex];
                    agencies.splice(agencyIndex, 1);
                    
                    // Update displays
                    updateAgencyList();
                    updateAgencyGrid();
                    updateUserAgencyDropdown();
                    
                    showNotification(`Agency "${deletedAgency.name}" has been deleted`, 'success');
                }
            }
        };

        function updateAgencyList() {
            const agencyList = document.getElementById('agencyList');
            agencyList.innerHTML = '';
            
            agencies.forEach(agency => {
                const agencyDiv = document.createElement('div');
                agencyDiv.className = 'agency-list-item';
                
                const coreAgencies = ['NPA', 'MOH', 'ZP'];
                const isCore = coreAgencies.includes(agency.code);
                
                agencyDiv.innerHTML = `
                    <div class="agency-info">
                        <div class="agency-code-display">${agency.code}</div>
                        <div class="agency-name-display">${agency.name}</div>
                        ${isCore ? '<small style="color: #28a745; font-weight: bold;">Core Agency</small>' : ''}
                    </div>
                    <div>
                        ${!isCore ? `<button onclick="deleteAgency('${agency.code}')" class="btn btn-sm" style="background: #dc3545; color: white;">Delete</button>` : '<span style="color: #28a745;">Protected</span>'}
                    </div>
                `;
                
                agencyList.appendChild(agencyDiv);
            });
        }

        function updateAgencyGrid() {
            const agencyGrid = document.getElementById('agencyGridContainer');
            if (!agencyGrid) return;
            
            agencyGrid.innerHTML = '';
            
            agencies.forEach(agency => {
                const agencyCard = document.createElement('div');
                agencyCard.className = 'agency-card';
                agencyCard.onclick = () => selectAgency(agency.code);
                
                agencyCard.innerHTML = `
                    <div class="agency-icon">${agency.icon}</div>
                    <div class="agency-name">${agency.name}</div>
                    <div class="agency-code">${agency.code}</div>
                    <div class="agency-display">${agency.code} - ${agency.name}</div>
                `;
                
                agencyGrid.appendChild(agencyCard);
            });
        }

        function updateUserAgencyDropdown() {
            const agencySelect = document.getElementById('newUserAgency');
            if (!agencySelect) return;
            
            // Clear existing options except the first one
            agencySelect.innerHTML = '<option value="">No specific agency (General Reporter)</option>';
            
            // Add all agencies
            agencies.forEach(agency => {
                const option = document.createElement('option');
                option.value = agency.code;
                option.textContent = `${agency.code} - ${agency.name}`;
                agencySelect.appendChild(option);
            });
        }

        // Enhanced User Management Functions
        window.toggleAgencySelection = function() {
            const role = document.getElementById('newUserRole').value;
            const agencyGroup = document.getElementById('agencySelectionGroup');
            
            if (role === 'reporter') {
                agencyGroup.style.display = 'block';
                updateUserAgencyDropdown();
            } else {
                agencyGroup.style.display = 'none';
            }
        };

        // Global functions
        window.fillLogin = function(username, password) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
        }

        window.handleLogin = function() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const errorDiv = document.getElementById('loginError');

  // Try Firebase first
  firebase.auth().signInWithEmailAndPassword(username + "@cvw.local", password)
    .then(cred => loadUserProfile(cred.user.uid))
    .then(profile => {
      if (profile) {
        currentUser = profile;
        currentUser.offline = false;
        showDashboard();
        errorDiv.style.display = 'none';
        showNotification(`Welcome, ${currentUser.name}!`, 'success');
      } else {
        showNotification("User profile not found in Firestore", "error");
      }
    })
    .catch(err => {
      console.warn("Firebase login failed, trying offline fallback:", err.message);

      // Offline fallback demo users
      const demoUsers = {
        admin: { password: "admin123", role: "admin", name: "Administrator", avatar: "A" },
        viewer: { password: "view123", role: "viewer", name: "Viewer", avatar: "V" },
        reporter: { password: "report123", role: "reporter", name: "Reporter", avatar: "R", agency: "NPA" }
      };

      if (demoUsers[username] && demoUsers[username].password === password) {
        currentUser = demoUsers[username];
        currentUser.offline = true;
        showDashboard();
        errorDiv.style.display = 'none';
        showNotification(`Welcome (offline), ${currentUser.name}!`, 'success');
      } else {
        errorDiv.style.display = 'block';
        errorDiv.textContent = "Invalid login credentials";
      }
    });
};

      if (demoUsers[username] && demoUsers[username].password === password) {
        currentUser = demoUsers[username];
        showDashboard();
        errorDiv.style.display = 'none';
        showNotification(`Welcome (offline), ${currentUser.name}!`, 'success');
      } else {
        errorDiv.style.display = 'block';
        errorDiv.textContent = "Invalid login credentials";
      }
    });
};

        // Hook generator into opening of Add Record modal
        window.openAddRecord = function() {
            const modal = document.getElementById('addRecordModal');
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => {
                    generateModalCaseId();
                    attachRecordTypeWatcher();
                }, 100); // ensure elements are rendered
            }
        };

        window.closeAddRecordModal = function() {
            const modal = document.getElementById('addRecordModal');
            if (modal) {
                modal.style.display = 'none';
                // Clear form fields
                document.getElementById('modalCaseId').value = '';
                document.getElementById('modalRecordType').value = '';
            }
        };

        // Ensure Case ID refreshes automatically when Record Type changes
        function attachRecordTypeWatcher() {
            const recordTypeSelect = document.getElementById('modalRecordType');
            if (recordTypeSelect) {
                recordTypeSelect.removeEventListener('change', generateModalCaseId);
                recordTypeSelect.addEventListener('change', generateModalCaseId);
            }
        }

        function selectAgency(agency) {
            selectedAgency = agency;
            
            // Update visual selection
            document.querySelectorAll('.agency-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.agency-card').classList.add('selected');
            
            // Show reporter actions section
            const reporterActionsSection = document.getElementById('reporterActionsSection');
            reporterActionsSection.classList.remove('hidden');
            reporterActionsSection.style.display = 'block';
            
            // Update agency info
            document.getElementById('currentAgencyName').textContent = getAgencyFullName(agency);
            document.getElementById('currentAgencyCode').textContent = agency;
            
            showNotification(`Selected agency: ${getAgencyFullName(agency)}`, 'success');
        }

        function updateKPIs() {
            const total = filteredData.length;
            const victims = filteredData.filter(d => d['Record Type'] === 'Victim').length;
            const witnesses = filteredData.filter(d => d['Record Type'] === 'Witness').length;
            const avgAge = total > 0 ? filteredData.reduce((sum, d) => sum + d['CVW Age'], 0) / total : 0;

            document.getElementById('totalCases').textContent = total;
            document.getElementById('victimCases').textContent = victims;
            document.getElementById('witnessCases').textContent = witnesses;
            document.getElementById('avgAge').textContent = Math.round(avgAge * 10) / 10;
        }

        function updateStatistics() {
            const total = filteredData.length;
            if (total === 0) return;

            // District analysis
            const districtCounts = {};
            filteredData.forEach(d => {
                districtCounts[d.District] = (districtCounts[d.District] || 0) + 1;
            });
            const topDistrict = Object.keys(districtCounts).reduce((a, b) => districtCounts[a] > districtCounts[b] ? a : b);

            // Crime analysis
            const crimeCounts = {};
            filteredData.forEach(d => {
                crimeCounts[d['Crime Type']] = (crimeCounts[d['Crime Type']] || 0) + 1;
            });
            const topCrime = Object.keys(crimeCounts).reduce((a, b) => crimeCounts[a] > crimeCounts[b] ? a : b);

            // Service analysis
            const serviceCounts = {};
            filteredData.forEach(d => {
                if (d['Services Rendered']) {
                    serviceCounts[d['Services Rendered']] = (serviceCounts[d['Services Rendered']] || 0) + 1;
                }
            });
            const topService = Object.keys(serviceCounts).length > 0 ? 
                Object.keys(serviceCounts).reduce((a, b) => serviceCounts[a] > serviceCounts[b] ? a : b) : 'N/A';

            // Gender analysis
            const femaleCases = filteredData.filter(d => d['CVW Gender'] === 'FEMALE').length;
            const maleCases = filteredData.filter(d => d['CVW Gender'] === 'MALE').length;
            const femalePercent = total > 0 ? Math.round((femaleCases / total) * 100) : 0;
            const malePercent = total > 0 ? Math.round((maleCases / total) * 100) : 0;

            // Update UI
            document.getElementById('topDistrict').textContent = topDistrict;
            document.getElementById('topCrime').textContent = topCrime;
            document.getElementById('topService').textContent = topService;
            document.getElementById('femaleCases').textContent = `${femaleCases} (${femalePercent}%)`;
            document.getElementById('maleCases').textContent = `${maleCases} (${malePercent}%)`;
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight: 600; color: #2c3e50;">${row['cvw code']}</td>
                    <td><span class="badge badge-${row['Record Type'].toLowerCase()}">${row['Record Type']}</span></td>
                    <td>${row['Date Reported'].toLocaleDateString()}</td>
                    <td>${row['District']}</td>
                    <td>${row['CVW Gender']}</td>
                    <td>${row['CVW Age']}</td>
                    <td>${row['Crime Type']}</td>
                    <td>${row['Services Rendered'] || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function createCharts() {
            try {
                // District chart
                const districtCounts = {};
                filteredData.forEach(d => {
                    districtCounts[d.District] = (districtCounts[d.District] || 0) + 1;
                });

                createChart('districtChart', 'bar', {
                    labels: Object.keys(districtCounts),
                    datasets: [{
                        label: 'Cases',
                        data: Object.values(districtCounts),
                        backgroundColor: colors.slice(0, Object.keys(districtCounts).length),
                        borderRadius: 8
                    }]
                });

                // Crime type chart
                const crimeCounts = {};
                filteredData.forEach(d => {
                    crimeCounts[d['Crime Type']] = (crimeCounts[d['Crime Type']] || 0) + 1;
                });

                createChart('crimeChart', 'doughnut', {
                    labels: Object.keys(crimeCounts),
                    datasets: [{
                        data: Object.values(crimeCounts),
                        backgroundColor: colors.slice(0, Object.keys(crimeCounts).length)
                    }]
                });

                // Age distribution
                const ageRanges = { '0-5': 0, '6-10': 0, '11-15': 0, '16-18': 0 };
                filteredData.forEach(d => {
                    const age = d['CVW Age'];
                    if (age <= 5) ageRanges['0-5']++;
                    else if (age <= 10) ageRanges['6-10']++;
                    else if (age <= 15) ageRanges['11-15']++;
                    else ageRanges['16-18']++;
                });

                createChart('ageChart', 'bar', {
                    labels: Object.keys(ageRanges),
                    datasets: [{
                        label: 'Count',
                        data: Object.values(ageRanges),
                        backgroundColor: colors.slice(0, 4),
                        borderRadius: 8
                    }]
                });

                // Gender distribution
                const genderCounts = {};
                filteredData.forEach(d => {
                    genderCounts[d['CVW Gender']] = (genderCounts[d['CVW Gender']] || 0) + 1;
                });

                createChart('genderChart', 'pie', {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        data: Object.values(genderCounts),
                        backgroundColor: colors.slice(0, Object.keys(genderCounts).length)
                    }]
                });

                // Time series
                const monthCounts = {};
                filteredData.forEach(d => {
                    const month = d['Date Reported'].toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    monthCounts[month] = (monthCounts[month] || 0) + 1;
                });

                createChart('timeChart', 'line', {
                    labels: Object.keys(monthCounts),
                    datasets: [{
                        label: 'Cases',
                        data: Object.values(monthCounts),
                        borderColor: colors[0],
                        backgroundColor: colors[0] + '30',
                        fill: true,
                        tension: 0.4
                    }]
                });

                // Services distribution
                const servicesCounts = {};
                filteredData.forEach(d => {
                    if (d['Services Rendered']) {
                        servicesCounts[d['Services Rendered']] = (servicesCounts[d['Services Rendered']] || 0) + 1;
                    }
                });

                createChart('servicesChart', 'doughnut', {
                    labels: Object.keys(servicesCounts),
                    datasets: [{
                        data: Object.values(servicesCounts),
                        backgroundColor: colors.slice(0, Object.keys(servicesCounts).length)
                    }]
                });

            } catch (error) {
                console.error('Error creating charts:', error);
            }
        }

        function createChart(canvasId, type, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Enhanced Auto-Refresh Filters (automatically applies when any filter changes)
        function applyFilters() {
            const district = document.getElementById('districtFilter').value;
            const recordType = document.getElementById('recordTypeFilter').value;
            const crimeType = document.getElementById('crimeTypeFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const ageRange = document.getElementById('ageRangeFilter').value;
            const dateRange = document.getElementById('dateRangeFilter').value;

            filteredData = allData.filter(row => {
                // District filter
                if (district && row.District !== district) return false;
                
                // Record type filter
                if (recordType && row['Record Type'] !== recordType) return false;
                
                // Crime type filter
                if (crimeType && row['Crime Type'] !== crimeType) return false;
                
                // Gender filter
                if (gender && row['CVW Gender'] !== gender) return false;
                
                // Age range filter
                if (ageRange) {
                    const age = row['CVW Age'];
                    switch (ageRange) {
                        case '0-5':
                            if (age < 0 || age > 5) return false;
                            break;
                        case '6-10':
                            if (age < 6 || age > 10) return false;
                            break;
                        case '11-15':
                            if (age < 11 || age > 15) return false;
                            break;
                        case '16-18':
                            if (age < 16 || age > 18) return false;
                            break;
                    }
                }
                
                // Date range filter
                if (dateRange) {
                    const today = new Date();
                    const recordDate = new Date(row['Date Reported']);
                    let cutoffDate = new Date();
                    
                    switch (dateRange) {
                        case 'last7days':
                            cutoffDate.setDate(today.getDate() - 7);
                            break;
                        case 'last30days':
                            cutoffDate.setDate(today.getDate() - 30);
                            break;
                        case 'last3months':
                            cutoffDate.setMonth(today.getMonth() - 3);
                            break;
                        case 'last6months':
                            cutoffDate.setMonth(today.getMonth() - 6);
                            break;
                        case 'thisyear':
                            cutoffDate = new Date(today.getFullYear(), 0, 1);
                            break;
                    }
                    
                    if (recordDate < cutoffDate) return false;
                }
                
                return true;
            });

            // Update all components automatically
            updateKPIs();
            updateStatistics();
            updateTable();
            createCharts();
            updateFilterSummary();
        }

        function resetFilters() {
            // Clear all filter selections
            document.getElementById('districtFilter').value = '';
            document.getElementById('recordTypeFilter').value = '';
            document.getElementById('crimeTypeFilter').value = '';
            document.getElementById('genderFilter').value = '';
            document.getElementById('ageRangeFilter').value = '';
            document.getElementById('dateRangeFilter').value = '';
            
            // Reset data
            filteredData = [...allData];
            
            // Update all components
            updateKPIs();
            updateStatistics();
            updateTable();
            createCharts();
            updateFilterSummary();
            
            showNotification('All filters reset', 'info');
        }

        function updateFilterSummary() {
            const filterSummary = document.getElementById('filterSummary');
            const activeFiltersSpan = document.getElementById('activeFilters');
            const filteredCountSpan = document.getElementById('filteredCount');
            const totalCountSpan = document.getElementById('totalCount');
            
            // Get active filters
            const activeFilters = [];
            
            const district = document.getElementById('districtFilter').value;
            const recordType = document.getElementById('recordTypeFilter').value;
            const crimeType = document.getElementById('crimeTypeFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const ageRange = document.getElementById('ageRangeFilter').value;
            const dateRange = document.getElementById('dateRangeFilter').value;
            
            if (district) activeFilters.push(`District: ${district}`);
            if (recordType) activeFilters.push(`Type: ${recordType}`);
            if (crimeType) activeFilters.push(`Crime: ${crimeType}`);
            if (gender) activeFilters.push(`Gender: ${gender}`);
            if (ageRange) activeFilters.push(`Age: ${ageRange}`);
            if (dateRange) activeFilters.push(`Date: ${dateRange}`);
            
            // Update display
            if (activeFilters.length > 0) {
                filterSummary.style.display = 'block';
                activeFiltersSpan.textContent = activeFilters.join(', ');
                filteredCountSpan.textContent = filteredData.length;
                totalCountSpan.textContent = allData.length;
            } else {
                filterSummary.style.display = 'none';
            }
        }

        // Modal and Form Functions
        window.openAddRecord = function() {
            console.log('Opening add record modal');
            const modal = document.getElementById('addRecordModal');
            modal.classList.remove('hidden');
            modal.classList.add('active');
            
            // Set default date to today
            document.getElementById('modalDateReported').value = new Date().toISOString().split('T')[0];
            
            // Focus on first field after a short delay
            setTimeout(() => {
                document.getElementById('modalRecordType').focus();
            }, 100);
        };

        window.closeAddRecordModal = function() {
            console.log('Closing add record modal');
            const modal = document.getElementById('addRecordModal');
            modal.classList.remove('active');
            modal.classList.add('hidden');
            
            // Reset all form fields
            document.getElementById('modalCaseId').value = '';
            document.getElementById('modalRecordType').value = '';
            document.getElementById('modalDateReported').value = '';
            document.getElementById('modalDistrict').value = '';
            document.getElementById('modalCvwGender').value = '';
            document.getElementById('modalCvwAge').value = '';
            document.getElementById('modalAgeUnit').value = '';
            document.getElementById('modalOffenderGender').value = '';
            document.getElementById('modalOffenderAge').value = '';
            document.getElementById('modalCrimeType').value = '';
            document.getElementById('modalDisability').value = 'NON';
            document.getElementById('modalServicesRendered').value = '';
            document.getElementById('modalRelationshipToCv').value = '';
            document.getElementById('modalAdditionalNotes').value = '';
            
            // Reset age input styling
            const ageInput = document.getElementById('modalCvwAge');
            if (ageInput) {
                ageInput.style.borderColor = '#e0e0e0';
                ageInput.style.backgroundColor = 'white';
                ageInput.max = '120';
                ageInput.placeholder = 'Enter age';
                ageInput.title = '';
            }
            
            // Hide messages
            hideModalMessages();
        };

        window.saveNewRecord = function() {
            console.log('Saving new record...');
            
            // Get form values
            const caseId = document.getElementById('modalCaseId').value;
            const recordType = document.getElementById('modalRecordType').value;
            const dateReported = document.getElementById('modalDateReported').value;
            const district = document.getElementById('modalDistrict').value;
            const gender = document.getElementById('modalCvwGender').value;
            const age = document.getElementById('modalCvwAge').value;
            const ageUnit = document.getElementById('modalAgeUnit').value;
            const offenderGender = document.getElementById('modalOffenderGender').value;
            const offenderAge = document.getElementById('modalOffenderAge').value;
            const crimeType = document.getElementById('modalCrimeType').value;
            const disability = document.getElementById('modalDisability').value;
            const services = document.getElementById('modalServicesRendered').value;
            const relationship = document.getElementById('modalRelationshipToCv').value;
            const notes = document.getElementById('modalAdditionalNotes').value;
            
            // Validate required fields
            const requiredFields = [];
            if (!recordType) requiredFields.push('Record Type');
            if (!dateReported) requiredFields.push('Date Reported');
            if (!district) requiredFields.push('District');
            if (!gender) requiredFields.push('CVW Gender');
            if (!age) requiredFields.push('CVW Age');
            if (!ageUnit) requiredFields.push('Age Unit');
            if (!crimeType) requiredFields.push('Crime Type');
            
            if (requiredFields.length > 0) {
                showModalError('Please fill in all required fields: ' + requiredFields.join(', '));
                return;
            }
            
            // Convert age to years for storage
            const ageInYears = convertAgeToYears(age, ageUnit);
            if (ageInYears === null) {
                showModalError('Invalid age format');
                return;
            }
            
            // Generate case ID if not provided
            let finalCaseId = caseId;
            if (!finalCaseId) {
                generateModalCaseId();
                finalCaseId = document.getElementById('modalCaseId').value;
            }
            
            // Create new record
            const newRecord = {
                'cvw code': finalCaseId,
                'Record Type': recordType,
                'Date Reported': new Date(dateReported),
                'District': district,
                'CVW Gender': gender,
                'CVW Age': ageInYears,
                'Offender Gender': offenderGender || '',
                'Offender Age': parseInt(offenderAge) || 0,
                'Crime Type': crimeType,
                'Disability': disability || 'NON',
                'Services Rendered': services || '',
                'Relationship to CV': relationship || ''
            };
            
            console.log('New record created:', newRecord);
            
            // Add to data
            allData.push(newRecord);
            filteredData = [...allData];
            if (navigator.onLine && !currentUser.offline) {
              saveRecordToFirestore(newRecord);
            } else {
              let offlineQueue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
              offlineQueue.push({ type: "case", record: newRecord });
              logSyncEvent('queued','case',newRecord['cvw code']);
              localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
              console.warn("Saved record offline:", newRecord['cvw code']);
            }
            
            // Update UI
            updateKPIs();
            updateStatistics();
            updateTable();
            createCharts();
            updateFilterSummary();
            
            // Show success message with readable age
            const ageDisplay = formatAgeDisplay(ageInYears);
            showModalSuccess(`Record ${finalCaseId} added successfully! (Age: ${ageDisplay})`);
            
            // Close modal after delay
            setTimeout(() => {
                closeAddRecordModal();
            }, 2000);
        };

        function showModalSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            if (successMsg) {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
            }
        }

        function showModalError(message) {
            const errorMsg = document.getElementById('errorMessage');
            if (errorMsg) {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                }, 5000);
            }
        }

        function hideModalMessages() {
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');
            if (successMsg) successMsg.style.display = 'none';
            if (errorMsg) errorMsg.style.display = 'none';
        }

        function getAgencyFullName(agencyCode) {
            const agency = agencies.find(a => a.code === agencyCode);
            return agency ? agency.name : agencyCode;
        }

        // Search Functions
        window.toggleSearch = function() {
            console.log('Toggling search...');
            const searchSection = document.getElementById('searchSection');
            if (searchSection.classList.contains('hidden')) {
                searchSection.classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('searchInput').focus();
                }, 100);
            } else {
                searchSection.classList.add('hidden');
                clearSearch();
            }
        };

        window.searchRecords = function() {
            console.log('Searching records...');
            const query = document.getElementById('searchInput').value.trim().toUpperCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                resultsDiv.innerHTML = '<p style="color: #dc2626; padding: 10px;">Please enter a search term</p>';
                resultsDiv.style.display = 'block';
                return;
            }

            const results = allData.filter(record => 
                record['cvw code'].toUpperCase().includes(query) ||
                record['District'].toUpperCase().includes(query) ||
                record['Crime Type'].toUpperCase().includes(query) ||
                record['CVW Gender'].toUpperCase().includes(query) ||
                (record['Services Rendered'] && record['Services Rendered'].toUpperCase().includes(query))
            );

            if (results.length === 0) {
                resultsDiv.innerHTML = `<p style="color: #dc2626; padding: 10px;">No records found for: "${query}"</p>`;
            } else {
                let html = `<h4 style="color: #2c3e50; margin-bottom: 15px; padding: 10px;">Found ${results.length} record(s):</h4>`;
                results.forEach((record, index) => {
                    const canUpdateServices = currentUser && currentUser.role === 'reporter' && selectedAgency;
                    html += `
                        <div class="result-item" style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <strong style="color: #667eea;">${record['cvw code']}</strong> - 
                                    <span class="badge badge-${record['Record Type'].toLowerCase()}" style="margin: 0 5px;">${record['Record Type']}</span> - 
                                    <strong>${record['District']}</strong>
                                    <br><small style="color: #6c757d;">${record['Crime Type']} | Age: ${record['CVW Age']} | Gender: ${record['CVW Gender']} | ${record['Date Reported'].toLocaleDateString()}</small>
                                    <br><strong style="color: #28a745;">Current Services: ${record['Services Rendered'] || 'None'}</strong>
                                </div>
                                ${canUpdateServices ? `
                                    <div style="margin-left: 15px;">
                                        <button class="btn btn-sm" style="background: #17a2b8; color: white;" onclick="openUpdateServicesModal('${record['cvw code']}')">Update Services</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
            }
            
            resultsDiv.style.display = 'block';
        };

        window.clearSearch = function() {
            console.log('Clearing search...');
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
        };

        // Export Functions
        window.exportPDF = function() {
    console.log('Exporting real PDF...');
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Title
      doc.setFontSize(18);
      doc.text("CVW Case Reports - Zambia", 14, 20);
      doc.setFontSize(12);
      doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);

      // Summary
      const dataToExport = filteredData.length > 0 ? filteredData : allData;
      const total = dataToExport.length;
      const victims = dataToExport.filter(d => d['Record Type'] === 'Victim').length;
      const witnesses = dataToExport.filter(d => d['Record Type'] === 'Witness').length;
      const avgAge = total > 0 ? dataToExport.reduce((sum, d) => sum + d['CVW Age'], 0) / total : 0;

      doc.setFontSize(14);
      doc.text("Summary Statistics:", 14, 45);
      doc.setFontSize(11);
      doc.text(`Total Cases: ${total}`, 14, 55);
      doc.text(`Victim Cases: ${victims}`, 14, 62);
      doc.text(`Witness Cases: ${witnesses}`, 14, 69);
      doc.text(`Average Age: ${avgAge.toFixed(1)} years`, 14, 76);

      // Table of cases
      const rows = dataToExport.map(record => [
        record['cvw code'],
        record['Record Type'],
        record['District'],
        record['CVW Age'],
        record['CVW Gender'],
        record['Crime Type'],
        record['Services Rendered'] || 'N/A',
        record['Date Reported'].toLocaleDateString()
      ]);

      doc.autoTable({
        head: [['Case ID','Type','District','Age','Gender','Crime','Services','Date']],
        body: rows,
        startY: 90,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [102, 126, 234] }
      });

      doc.save(`CVW_Report_${new Date().toISOString().split('T')[0]}.pdf`);
      showNotification(`PDF exported successfully! ${rows.length} records included.`, 'success');
    } catch (error) {
      console.error("PDF export error:", error);
      showNotification("Error generating PDF. Please try again.", "error");
    }
};
                dataToExport.forEach(d => {
                    districtCounts[d.District] = (districtCounts[d.District] || 0) + 1;
                });
                
                pdfContent += `DISTRICT BREAKDOWN:\n`;
                pdfContent += `==================\n`;
                Object.entries(districtCounts).sort((a, b) => b[1] - a[1]).forEach(([district, count]) => {
                    const percentage = Math.round((count / dataToExport.length) * 100);
                    pdfContent += `‚Ä¢ ${district}: ${count} cases (${percentage}%)\n`;
                });
                pdfContent += `\n`;
                
                // Crime type breakdown
                const crimeCounts = {};
                dataToExport.forEach(d => {
                    crimeCounts[d['Crime Type']] = (crimeCounts[d['Crime Type']] || 0) + 1;
                });
                
                pdfContent += `CRIME TYPE BREAKDOWN:\n`;
                pdfContent += `====================\n`;
                Object.entries(crimeCounts).sort((a, b) => b[1] - a[1]).forEach(([crime, count]) => {
                    const percentage = Math.round((count / dataToExport.length) * 100);
                    pdfContent += `‚Ä¢ ${crime}: ${count} cases (${percentage}%)\n`;
                });
                pdfContent += `\n`;
                
                pdfContent += `DETAILED CASE RECORDS:\n`;
                pdfContent += `=====================\n`;
                pdfContent += `${'='.repeat(80)}\n`;
                
                dataToExport.forEach((record, index) => {
                    pdfContent += `${index + 1}. CASE ID: ${record['cvw code']}\n`;
                    pdfContent += `   Type: ${record['Record Type']}\n`;
                    pdfContent += `   District: ${record['District']}\n`;
                    pdfContent += `   Age: ${record['CVW Age']} years\n`;
                    pdfContent += `   Gender: ${record['CVW Gender']}\n`;
                    pdfContent += `   Crime: ${record['Crime Type']}\n`;
                    pdfContent += `   Date Reported: ${record['Date Reported'].toLocaleDateString()}\n`;
                    pdfContent += `   Services Rendered: ${record['Services Rendered'] || 'None'}\n`;
                    pdfContent += `${'-'.repeat(80)}\n`;
                });
                
                pdfContent += `\nEND OF REPORT\n`;
                pdfContent += `Generated by CVW Dashboard - Zambia Child Victim & Witness Analytics System\n`;
                
                const blob = new Blob([pdfContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `CVW_Report_${new Date().toISOString().split('T')[0]}_${new Date().toTimeString().split(' ')[0].replace(/:/g, '')}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`Report exported successfully! ${dataToExport.length} records included.`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error generating PDF report. Please try again.', 'error');
            }
        };

        window.exportCSV = function() {
            console.log('Exporting CSV...');
            try {
                const dataToExport = filteredData.length > 0 ? filteredData : allData;
                
                if (dataToExport.length === 0) {
                    showNotification('No data to export', 'error');
                    return;
                }
                
                const headers = ['Case_ID', 'Record_Type', 'Date_Reported', 'District', 'Gender', 'Age', 'Crime_Type', 'Services_Rendered'];
                const rows = dataToExport.map(record => [
                    record['cvw code'],
                    record['Record Type'],
                    record['Date Reported'].toLocaleDateString(),
                    record['District'],
                    record['CVW Gender'],
                    record['CVW Age'],
                    record['Crime Type'],
                    record['Services Rendered'] || 'N/A'
                ]);
                
                const csvContent = [headers, ...rows]
                    .map(row => row.map(field => {
                        // Escape quotes and wrap in quotes if needed
                        const stringField = String(field);
                        if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                            return `"${stringField.replace(/"/g, '""')}"`;
                        }
                        return stringField;
                    }).join(','))
                    .join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `CVW_Data_${new Date().toISOString().split('T')[0]}_${new Date().toTimeString().split(' ')[0].replace(/:/g, '')}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`CSV exported successfully! ${dataToExport.length} records included.`, 'success');
            } catch (error) {
                console.error('CSV export error:', error);
                showNotification('Error generating CSV file. Please try again.', 'error');
            }
        };

        // Update Services Functions
        window.openUpdateServicesModal = function(caseId) {
            console.log('Opening update services modal for case:', caseId);
            
            // Find the case record
            const caseRecord = allData.find(record => record['cvw code'] === caseId);
            if (!caseRecord) {
                showNotification('Case not found', 'error');
                return;
            }
            
            // Populate case information
            document.getElementById('updateCaseId').textContent = caseId;
            document.getElementById('updateCurrentServices').textContent = caseRecord['Services Rendered'] || 'None';
            document.getElementById('updateAgencyName').textContent = currentUser.agency ? getAgencyFullName(currentUser.agency) : selectedAgency ? getAgencyFullName(selectedAgency) : 'Unknown';
            
            // Set default service date to today
            document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
            
            // Show modal
            const modal = document.getElementById('updateServicesModal');
            modal.classList.remove('hidden');
            modal.classList.add('active');
            
            // Focus on service selector
            setTimeout(() => {
                document.getElementById('additionalService').focus();
            }, 100);
        };

        window.closeUpdateServicesModal = function() {
            console.log('Closing update services modal');
            const modal = document.getElementById('updateServicesModal');
            modal.classList.remove('active');
            modal.classList.add('hidden');
            
            // Reset form
            document.getElementById('additionalService').value = '';
            document.getElementById('serviceNotes').value = '';
            document.getElementById('serviceDate').value = '';
        };

        window.saveUpdatedServices = function() {
            console.log('Saving updated services...');
            
            const caseId = document.getElementById('updateCaseId').textContent;
            const additionalService = document.getElementById('additionalService').value;
            const serviceNotes = document.getElementById('serviceNotes').value;
            const serviceDate = document.getElementById('serviceDate').value;
            
            // Validate required fields
            if (!additionalService || !serviceDate) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Find and update the case record
            const caseIndex = allData.findIndex(record => record['cvw code'] === caseId);
            if (caseIndex === -1) {
                showNotification('Case not found', 'error');
                return;
            }
            
            const currentServices = allData[caseIndex]['Services Rendered'];
            let updatedServices;
            
            if (!currentServices || currentServices === 'N/A' || currentServices === 'None') {
                updatedServices = additionalService;
            } else {
                // Check if service already exists to avoid duplicates
                if (currentServices.toUpperCase().includes(additionalService.toUpperCase())) {
                    showNotification('This service is already recorded for this case', 'error');
                    return;
                }
                updatedServices = currentServices + ' + ' + additionalService;
            }
            
            // Update the record
            allData[caseIndex]['Services Rendered'] = updatedServices;
            allData[caseIndex]['Last Updated'] = new Date(serviceDate);
            allData[caseIndex]['Updated By'] = currentUser.agency || selectedAgency;
            
            if (serviceNotes) {
                allData[caseIndex]['Service Notes'] = serviceNotes;
            }
            
            // Update filtered data if it contains this record
            const filteredIndex = filteredData.findIndex(record => record['cvw code'] === caseId);
            if (filteredIndex !== -1) {
                filteredData[filteredIndex] = { ...allData[caseIndex] };
            }
            
            // Refresh UI components
            updateKPIs();
            updateStatistics();
            updateTable();
            createCharts();
            updateFilterSummary();
            
            // If search results are visible, refresh them
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim()) {
                searchRecords();
            }
            
            // Close modal and show success
            closeUpdateServicesModal();
            showNotification(`Services updated for case ${caseId}: Added "${additionalService}"`, 'success');
        };

        window.exportFilteredData = function() {
            exportCSV();
        };

        // User Management Functions
        window.manageUsers = function() {
            console.log('Opening user management...');
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Access denied: Only administrators can manage users', 'error');
                return;
            }
            
            const modal = document.getElementById('userMgmtModal');
            modal.classList.remove('hidden');
            modal.classList.add('active');
            updateUsersList();
            updateUserAgencyDropdown();
        };

        window.closeUserMgmtModal = function() {
            console.log('Closing user management modal');
            const modal = document.getElementById('userMgmtModal');
            modal.classList.remove('active');
            modal.classList.add('hidden');
        };

        window.addNewUser = function() {
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  const role = document.getElementById('newRole').value;
  const name = document.getElementById('newName').value.trim();
  const agency = document.getElementById('newAgency').value.trim();

  if (!username || !password || !role || !name) {
    showNotification("Please fill in all required fields", "error");
    return;
  }

  const newUser = { username, role, name, agency, avatar: name.charAt(0).toUpperCase() };

  if (navigator.onLine && !currentUser.offline) {
    firebase.auth().createUserWithEmailAndPassword(username + "@cvw.local", password)
      .then(cred => saveUserToFirestore(cred.user.uid, newUser))
      .then(() => {
        updateUsersList();
        showNotification(`User ${username} created successfully`, "success");
      })
      .catch(err => {
        showNotification("Error creating user: " + err.message, "error");
      });
  } else {
    let offlineQueue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
    offlineQueue.push({ type: "user", userId: username, profile: newUser });
    logSyncEvent('queued','user',username);
    localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
    showNotification(`User ${username} saved offline and will sync later.`, "warning");
  }
};

            // Add agency if reporter and agency selected
            if (role === 'reporter' && agency) {
                newUser.agency = agency;
            }

            firebase.auth().createUserWithEmailAndPassword(username + "@cvw.local", password)
            .then(cred => {
                return saveUserToFirestore(cred.user.uid, newUser);
            })
            .then(() => {
                updateUsersList();
                showNotification(`User "${username}" created in Firebase`, "success");
            })
            .catch(err => {
                showNotification("Error creating user: " + err.message, "error");
            });

            updateUsersList();
            
            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserRole').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserAgency').value = '';
            document.getElementById('agencySelectionGroup').style.display = 'none';
            
            const agencyText = agency ? ` with ${agency} agency` : '';
            showNotification(`User "${username}" added successfully with ${role} role${agencyText}`, 'success');
        };

        window.resetUserPassword = function(username) {
            console.log('Resetting password for:', username);
            const newPassword = prompt(`Enter new password for user "${username}":\n\n(Password must be at least 6 characters long)`);
            if (newPassword && newPassword.trim() && newPassword.length >= 6) {
                users[username].password = newPassword.trim();
                showNotification(`Password successfully reset for user "${username}"`, 'success');
            } else if (newPassword !== null && newPassword !== '') {
                showNotification('Password must be at least 6 characters long', 'error');
            }
        };

        window.updateUsersList = function() {
            console.log('Updating users list...');
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            db.collection("users").get().then(snapshot => {
                users = {}; // reset cache
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const username = user.username;
                    users[username] = user;
                const user = users[username];
                const userDiv = document.createElement('div');
                userDiv.style.cssText = 'padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; display: flex; justify-content: space-between; align-items: center;';
                
                const createdDate = user.createdAt ? user.createdAt.toLocaleDateString() : 'N/A';
                const agencyInfo = user.agency ? ` | Agency: ${user.agency}` : '';
                
                userDiv.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: #2c3e50;">${user.name}</div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Username: ${username} | Role: ${user.role}${agencyInfo}</div>
                        <div style="font-size: 0.8rem; color: #adb5bd;">Created: ${createdDate}</div>
                    </div>
                    <div>
                        <button onclick="resetUserPassword('${username}')" class="btn btn-sm btn-info" style="margin-right: 5px;">Reset Password</button>
                        ${username !== 'admin' ? `<button onclick="deleteUser('${username}')" class="btn btn-sm" style="background: #dc3545; color: white;">Delete</button>` : ''}
                    </div>
                `;
                
                usersList.appendChild(userDiv);
                });
            });
        };

        window.deleteUser = function(username) {
            console.log('Deleting user:', username);
            if (username === 'admin') {
                showNotification('Cannot delete the administrator account', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
                delete users[username];
                updateUsersList();
                showNotification(`User "${username}" has been deleted`, 'success');
            }
        };

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                selectedAgency = null;
                
                // Clear all filters and search states
                clearAllFiltersAndSearch();
                
                // Hide dashboard and show login
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainDashboard').classList.add('hidden');
                
                // Clear login form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                showNotification('Logged out successfully', 'info');
            }
        }

        function clearAllFiltersAndSearch() {
            // Clear all filter selections
            const filterSelectors = [
                'districtFilter', 'recordTypeFilter', 'crimeTypeFilter', 
                'genderFilter', 'ageRangeFilter', 'dateRangeFilter'
            ];
            
            filterSelectors.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.value = '';
                }
            });
            
            // Clear search input and results
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchSection = document.getElementById('searchSection');
            
            if (searchInput) searchInput.value = '';
            if (searchResults) {
                searchResults.style.display = 'none';
                searchResults.innerHTML = '';
            }
            if (searchSection) {
                searchSection.classList.add('hidden');
            }
            
            // Hide filter summary
            const filterSummary = document.getElementById('filterSummary');
            if (filterSummary) {
                filterSummary.style.display = 'none';
            }
            
            // Reset filtered data to all data
            filteredData = [...allData];
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Add event listeners when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Enter key support for login
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // Modal close on background click
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    if (e.target.id === 'addRecordModal') {
                        closeAddRecordModal();
                    } else if (e.target.id === 'userMgmtModal') {
                        closeUserMgmtModal();
                    } else if (e.target.id === 'updateServicesModal') {
                        closeUpdateServicesModal();
                    } else if (e.target.id === 'agencyModal') {
                        closeAgencyModal();
                    }
                }
            });

            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // Close all modals
                    const addModal = document.getElementById('addRecordModal');
                    const userModal = document.getElementById('userMgmtModal');
                    const updateModal = document.getElementById('updateServicesModal');
                    const agencyModal = document.getElementById('agencyModal');
                    
                    if (addModal && addModal.classList.contains('active')) {
                        closeAddRecordModal();
                    }
                    if (userModal && userModal.classList.contains('active')) {
                        closeUserMgmtModal();
                    }
                    if (updateModal && updateModal.classList.contains('active')) {
                        closeUpdateServicesModal();
                    }
                    if (agencyModal && agencyModal.classList.contains('active')) {
                        closeAgencyModal();
                    }
                }
            });

            // Enter key in search
            document.addEventListener('keypress', function(e) {
                if (e.target.id === 'searchInput' && e.key === 'Enter') {
                    searchRecords();
                }
            });

            // Auto-validation for agency code input (uppercase only)
            document.addEventListener('input', function(e) {
                if (e.target.id === 'newAgencyCode') {
                    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
                }
            });
        });
    
window.showSyncHistory = function() {
  let history = JSON.parse(localStorage.getItem("syncHistory") || "[]");
  if (history.length === 0) {
    alert("No sync history available.");
    return;
  }
  let logText = history.map(h =>
    `[${h.time}] ${h.action.toUpperCase()} ${h.type} ‚Üí ${h.details}`
  ).join("\n");
  alert("Sync History:\n\n" + logText);
};
</script>
</body>
</html>
