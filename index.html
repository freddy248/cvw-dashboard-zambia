<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>CVW Dashboard - Zambia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js">
async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            max-width: 400px;
            margin: 10vh auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            text-align: center;
        }

        .login-title {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .demo-accounts {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .account-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            padding: 30px;
            border-bottom: 2px solid #667eea;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .user-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .section {
            background: white;
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-content {
            padding: 30px;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .agency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .agency-card {
            background: #f8f9fa;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .agency-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .agency-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .agency-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .agency-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .agency-code {
            background: rgba(0, 0, 0, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .agency-display {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .kpi-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .filter-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-victim {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-witness {
            background: #dbeafe;
            color: #2563eb;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification.success {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #10b981;
        }

        .notification.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .notification.info {
            background: #dbeafe;
            color: #2563eb;
            border: 1px solid #3b82f6;
        }

        .notification.warning {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #f59e0b;
        }

        .statistics-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .stats-label {
            font-weight: 600;
            color: #495057;
        }

        .stats-value {
            color: #2c3e50;
            font-weight: bold;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex !important;
        }

        .modal-container {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .agency-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

.badge-service {
  display: inline-block;
  background: #eef2ff;
  color: #4f46e5;
  padding: 3px 8px;
  margin: 2px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

</style>


</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
    <h1 class="login-title">📊 CVW Dashboard</h1>
    <p class="login-subtitle">Zambia Child Victim & Witness Analytics</p>
    
    <div class="notification error" id="loginError" style="position: static; display: none; margin-bottom: 20px;">
        Invalid credentials
    </div>
    
    <div id="loginForm">
        <div class="form-group">
            <input class="form-input" id="username" placeholder="Username" required type="text"/>
        </div>
        <div class="form-group">
            <input class="form-input" id="password" placeholder="Password" required type="password"/>
        </div>
        <button class="btn btn-primary" onclick="handleLogin()" type="button">🚀 Login</button>
    </div>
    
    <div class="demo-accounts">
        <h3 style="margin-bottom: 15px; color: #2c3e50;">Demo Accounts</h3>
        <div class="account-row">
            <span><strong>Admin:</strong> admin / admin123</span>
            <button class="btn btn-sm btn-success" onclick="fillLogin('admin', 'admin123')">Fill</button>
        </div>
        <div class="account-row">
            <span><strong>Viewer:</strong> viewer / view123</span>
            <button class="btn btn-sm btn-info" onclick="fillLogin('viewer', 'view123')">Fill</button>
        </div>
        <div class="account-row">
            <span><strong>General Reporter:</strong> reporter / report123</span>
            <button class="btn btn-sm btn-warning" onclick="fillLogin('reporter', 'report123')">Fill</button>
        </div>
        <div class="account-row">
            <span><strong>NPA Reporter:</strong> npa_reporter / npa_reporter</span>
            <button class="btn btn-sm" onclick="fillLogin('npa_reporter', 'npa_reporter')" style="background: #6f42c1; color: white;">Fill</button>
        </div>
        <div class="account-row">
            <span><strong>MOH Reporter:</strong> moh_reporter / moh_reporter</span>
            <button class="btn btn-sm" onclick="fillLogin('moh_reporter', 'moh_reporter')" style="background: #e83e8c; color: white;">Fill</button>
        </div>
        <div class="account-row">
            <span><strong>ZP Reporter:</strong> zp_reporter / zp_reporter</span>
            <button class="btn btn-sm" onclick="fillLogin('zp_reporter', 'zp_reporter')" style="background: #20c997; color: white;">Fill</button>
        </div>
    </div>
</div>

<!-- Main Dashboard -->
<div class="container hidden" id="mainDashboard">
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">A</div>
            <div>
                <div id="userName" style="font-weight: 600; color: #2c3e50;">Administrator</div>
                <div id="userRole" style="font-size: 0.9rem; color: #7f8c8d;">Admin Account</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <!-- Connection Status Indicator -->
            <div id="connectionStatus" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                <div id="statusDot" style="width: 8px; height: 8px; border-radius: 50%;"></div>
                <span id="statusText">Offline Mode</span>
            </div>
            <button class="btn" onclick="logout()" style="background: #dc3545; color: white;">🚪 Logout</button>
        </div>
    </div>

    <!-- Header -->
    <div class="dashboard">
        <div class="header">
            <h1>📊 CVW Analytics Dashboard</h1>
            <p style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin: 10px 0;">ZAMBIA</p>
            <p class="subtitle">Child Victim & Witness Case Management System</p>
        </div>
    </div>

    <!-- Dashboard Controls Section (Admin) -->
    <div class="section" id="dashboardControlsSection">
        <div class="section-header">🎛️ Dashboard Controls</div>
        <div class="section-content">
            <div class="action-grid">
                <button class="btn btn-success" onclick="openAddRecord()">➕ Add New Record</button>
                <button class="btn btn-info" onclick="toggleSearch()">🔍 Search Records</button>
                <button class="btn" onclick="exportPDF()" style="background: #dc3545; color: white;">📄 Export PDF</button>
                <button class="btn" onclick="exportCSV()" style="background: #28a745; color: white;">📊 Export CSV</button>
                <button class="btn" onclick="manageUsers()" style="background: #6f42c1; color: white;">👥 Manage Users</button>
                <button class="btn" onclick="manageAgencies()" style="background: #fd7e14; color: white;">🏢 Manage Agencies</button>
            </div>
        </div>
    </div>

    <!-- Export & Reports Section (Viewer) -->
    <div class="section hidden" id="exportReportsSection">
        <div class="section-header">📤 Export & Reports</div>
        <div class="section-content">
            <div class="action-grid">
                <button class="btn" onclick="exportPDF()" style="background: #dc3545; color: white;">📄 Export PDF</button>
                <button class="btn" onclick="exportCSV()" style="background: #28a745; color: white;">📊 Export CSV</button>
            </div>
        </div>
    </div>

    <!-- Agency Section (Reporter) -->
    <div class="section hidden" id="agencySection">
        <div class="section-header">🏢 Agency Selection</div>
        <div class="section-content">
            <div class="agency-grid" id="agencyGridContainer">
                <div class="agency-card" onclick="selectAgency('NPA')">
                    <div class="agency-icon">⚖️</div>
                    <div class="agency-name">National Prosecution Authority</div>
                    <div class="agency-code">NPA</div>
                    <div class="agency-display">NPA - National Prosecution Authority</div>
                </div>
                <div class="agency-card" onclick="selectAgency('ZP')">
                    <div class="agency-icon">👮</div>
                    <div class="agency-name">Zambia Police</div>
                    <div class="agency-code">ZP</div>
                    <div class="agency-display">ZP - Zambia Police</div>
                </div>
                <div class="agency-card" onclick="selectAgency('MOH')">
                    <div class="agency-icon">🏥</div>
                    <div class="agency-name">Ministry of Health</div>
                    <div class="agency-code">MOH</div>
                    <div class="agency-display">MOH - Ministry of Health</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reporter Actions Section -->
    <div class="section hidden" id="reporterActionsSection">
        <div class="section-header">📝 Reporter Actions</div>
        <div class="section-content">
            <div class="statistics-summary" id="selectedAgencyInfo" style="margin-bottom: 20px;">
                <div class="stats-row">
                    <span class="stats-label">Selected Agency:</span>
                    <span class="stats-value" id="currentAgencyName">Not Selected</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Agency Code:</span>
                    <span class="stats-value" id="currentAgencyCode">N/A</span>
                </div>
            </div>
            <div class="action-grid">
                <button class="btn btn-success" onclick="openAddRecord()">➕ Add New Record</button>
                <button class="btn btn-info" onclick="toggleSearch()">🔍 Search Records</button>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="section hidden" id="searchSection">
        <div class="section-header">🔍 Case Search</div>
        <div class="section-content">
            <div class="search-box">
                <input class="search-input" id="searchInput" placeholder="Enter Case ID (e.g., NPA-CV1, MOH-CW5) or search by district, crime type" type="text"/>
                <button class="btn btn-primary" onclick="searchRecords()">Search</button>
                <button class="btn" onclick="clearSearch()" style="background: #6c757d; color: white;">Clear</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="section" id="filtersSection">
        <div class="section-header">🔧 Data Filters</div>
        <div class="section-content">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">District</label>
                    <select class="filter-select" id="districtFilter" onchange="applyFilters()">
                        <option value="">All Districts</option>
                        <option value="Lusaka">Lusaka</option>
                        <option value="Ndola">Ndola</option>
                        <option value="Kitwe">Kitwe</option>
                        <option value="Livingstone">Livingstone</option>
                        <option value="Katete">Katete</option>
                        <option value="Kabwe">Kabwe</option>
                        <option value="Chingola">Chingola</option>
                        <option value="Mufulira">Mufulira</option>
                        <option value="Luanshya">Luanshya</option>
                        <option value="Kasama">Kasama</option>
                        <option value="Chipata">Chipata</option>
                        <option value="Solwezi">Solwezi</option>
                        <option value="Mongu">Mongu</option>
                        <option value="Mazabuka">Mazabuka</option>
                        <option value="Monze">Monze</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Record Type</label>
                    <select class="filter-select" id="recordTypeFilter" onchange="applyFilters()">
                        <option value="">All Types</option>
                        <option value="Victim">Victim</option>
                        <option value="Witness">Witness</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Crime Type</label>
                    <select class="filter-select" id="crimeTypeFilter" onchange="applyFilters()">
                        <option value="">All Crime Types</option>
                        <option value="RAPE">Rape</option>
                        <option value="DEFILEMENT">Defilement</option>
                        <option value="ASSAULT ON A CHILD">Assault on a Child</option>
                        <option value="CHILD ABUSE">Child Abuse</option>
                        <option value="TRAFFICKING">Trafficking</option>
                        <option value="NEGLECT">Neglect</option>
                        <option value="EXPLOITATION">Exploitation</option>
                        <option value="DOMESTIC VIOLENCE">Domestic Violence</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Gender</label>
                    <select class="filter-select" id="genderFilter" onchange="applyFilters()">
                        <option value="">All Genders</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Age Range</label>
                    <select class="filter-select" id="ageRangeFilter" onchange="applyFilters()">
                        <option value="">All Ages</option>
                        <option value="0-5">0-5 years</option>
                        <option value="6-10">6-10 years</option>
                        <option value="11-15">11-15 years</option>
                        <option value="16-18">16-18 years</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <select class="filter-select" id="dateRangeFilter" onchange="applyFilters()">
                        <option value="">All Dates</option>
                        <option value="last7days">Last 7 days</option>
                        <option value="last30days">Last 30 days</option>
                        <option value="last3months">Last 3 months</option>
                        <option value="last6months">Last 6 months</option>
                        <option value="thisyear">This year</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="resetFilters()" style="background: #ffc107; color: #000;">🔄 Reset All</button>
                <button class="btn" onclick="exportFilteredData()" style="background: #28a745; color: white;">📊 Export Filtered Data</button>
            </div>
            <!-- Filter Results Summary -->
            <div class="statistics-summary" id="filterSummary" style="margin-top: 20px; display: none;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">🎯 Filter Results</h4>
                <div class="stats-row">
                    <span class="stats-label">Active Filters:</span>
                    <span class="stats-value" id="activeFilters">None</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Records Shown:</span>
                    <span class="stats-value" id="filteredCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Total Records:</span>
                    <span class="stats-value" id="totalCount">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="section" id="kpiSection">
        <div class="section-header">📊 Key Performance Indicators</div>
        <div class="section-content">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="totalCases">6</div>
                    <div class="kpi-label">Total Cases</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="victimCases">4</div>
                    <div class="kpi-label">Victim Cases</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="witnessCases">2</div>
                    <div class="kpi-label">Witness Cases</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="avgAge">10.5</div>
                    <div class="kpi-label">Average Age</div>
                </div>
            </div>
            <!-- Statistics Summary -->
            <div class="statistics-summary">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">📈 Summary Statistics</h4>
                <div class="stats-row">
                    <span class="stats-label">Most Affected District:</span>
                    <span class="stats-value" id="topDistrict">Lusaka</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Most Common Crime:</span>
                    <span class="stats-value" id="topCrime">Rape</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Most Common Service:</span>
                    <span class="stats-value" id="topService">Medical Report</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Female Cases:</span>
                    <span class="stats-value" id="femaleCases">3 (50%)</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Male Cases:</span>
                    <span class="stats-value" id="maleCases">3 (50%)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="section" id="chartsSection">
        <div class="section-header">📈 Analytics Charts</div>
        <div class="section-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Cases by District</div>
                    <div class="chart-canvas">
                        <canvas id="districtChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Crime Types</div>
                    <div class="chart-canvas">
                        <canvas id="crimeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Age Distribution</div>
                    <div class="chart-canvas">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Gender Distribution</div>
                    <div class="chart-canvas">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Cases Over Time</div>
                    <div class="chart-canvas">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Services Rendered</div>
                    <div class="chart-canvas">
                        <canvas id="servicesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="section" id="tableSection">
        <div class="section-header">📋 Case Records</div>
        <div class="section-content">
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case ID</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>District</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Crime Type</th>
                            <th>Services</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add New Record Modal -->
<div class="modal-overlay" id="addRecordModal" style="display: none;">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <h2>Add New Case Record</h2>
            <button class="modal-close" onclick="closeAddRecordModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="notification success" id="successMessage" style="display: none; margin-bottom: 20px;">
                Record added successfully!
            </div>
            <div class="notification error" id="errorMessage" style="display: none; margin-bottom: 20px;">
                Please fill in all required fields.
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Case ID</label>
                    <input id="modalCaseId" placeholder="Auto-generated if empty" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
                    <small style="color: #666; margin-top: 5px; display: block;">Will be auto-generated based on record type</small>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Record Type *</label>
                    <select id="modalRecordType" onchange="generateModalCaseId()" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">Select Type</option>
                        <option value="Victim">Victim</option>
                        <option value="Witness">Witness</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Date Reported *</label>
                    <input id="modalDateReported" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="date"/>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">District *</label>
                    <select id="modalDistrict" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">Select District</option>
                        <option value="Lusaka">Lusaka</option>
                        <option value="Kitwe">Kitwe</option>
                        <option value="Ndola">Ndola</option>
                        <option value="Kabwe">Kabwe</option>
                        <option value="Chingola">Chingola</option>
                        <option value="Mufulira">Mufulira</option>
                        <option value="Livingstone">Livingstone</option>
                        <option value="Luanshya">Luanshya</option>
                        <option value="Kasama">Kasama</option>
                        <option value="Chipata">Chipata</option>
                        <option value="Katete">Katete</option>
                        <option value="Solwezi">Solwezi</option>
                        <option value="Mongu">Mongu</option>
                        <option value="Mazabuka">Mazabuka</option>
                        <option value="Monze">Monze</option>
                        <option value="Mansa">Mansa</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">CVW Gender *</label>
                    <select id="modalCvwGender" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">Select Gender</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">CVW Age *</label>
                    <input id="modalCvwAge" max="18" min="0" placeholder="Enter age (0-18)" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="number"/>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Crime Type *</label>
                    <select id="modalCrimeType" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">Select Crime Type</option>
                        <option value="ASSAULT ON A CHILD">Assault on a Child</option>
                        <option value="PHYSICAL ABUSE">Physical Abuse</option>
                        <option value="SEXUAL ASSAULT">Sexual Assault</option>
                        <option value="RAPE">Rape</option>
                        <option value="CHILD NEGLECT">Child Neglect</option>
                        <option value="DEFILEMENT">Defilement</option>
                        <option value="ONLINE SEXUAL EXPLOITATION">Online Sexual Exploitation</option>
                        <option value="TRAFFICKING">Trafficking</option>
                        <option value="NEGLECT">Neglect</option>
                        <option value="EXPLOITATION">Exploitation</option>
                        <option value="DOMESTIC VIOLENCE">Domestic Violence</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Services Rendered</label>
                    <select id="modalServicesRendered" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">Select Services</option>
                        <option value="MEDICAL REPORT">Medical Report</option>
                        <option value="COUNSELLING">Counselling</option>
                        <option value="LEGAL AID">Legal Aid</option>
                        <option value="PSYCHOSOCIAL SUPPORT">Psychosocial Support</option>
                        <option value="SHELTER">Shelter</option>
                        <option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
                        <option value="LEGAL + COUNSELLING">Legal + Counselling</option>
                        <option value="REFERRAL">Referral</option>
                        <option value="FOLLOW-UP">Follow-up</option>
                        <option value="REHABILITATION">Rehabilitation</option>
                        <option value="FAMILY SUPPORT">Family Support</option>
                        <option value="EMERGENCY CARE">Emergency Care</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Additional Notes (Optional)</label>
                <textarea id="modalAdditionalNotes" placeholder="Any additional information about the case..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;"></textarea>
            </div>
        </div>
        <div style="padding: 20px 30px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 15px;">
            <button class="btn" onclick="closeAddRecordModal()" style="background: #6c757d; color: white;" type="button">Cancel</button>
            <button class="btn btn-primary" onclick="saveNewRecord()" type="button">Save Record</button>
        </div>
    </div>
</div>

<!-- User Management Modal -->
<div class="modal-overlay" id="userMgmtModal" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2>👥 User Management</h2>
            <button class="modal-close" onclick="closeUserMgmtModal()">×</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Add New User</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Username</label>
                        <input id="newUsername" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Password</label>
                        <input id="newPassword" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="password"/>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Role</label>
                        <select id="newUserRole" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="viewer">Viewer</option>
                            <option value="reporter">Reporter</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Full Name</label>
                        <input id="newUserName" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>

<div class="form-group">
    <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Agency</label>
    <select id="newUserAgency" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
        <option value="">-- Select Agency --</option>
        <option value="NPA">NPA - National Prosecution Authority</option>
        <option value="MOH">MOH - Ministry of Health</option>
        <option value="ZP">ZP - Zambia Police</option>
        <option value="CCCI">CCCI</option>
    </select>
</div>

                    </div>
                </div>
                <button class="btn btn-success" onclick="addNewUser()">+ Add User</button>
            </div>
            <div>
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Existing Users</h3>
                <div id="usersList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js">
async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>


<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js">
async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js">
async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js">
async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBo0jRzfh3DVNdCkPjXXgwvi2cfacXE1Ok",
    authDomain: "cvw-dashboard-zambia.firebaseapp.com",
    projectId: "cvw-dashboard-zambia",
    storageBucket: "cvw-dashboard-zambia.appspot.com",
    messagingSenderId: "905368303709",
    appId: "1:905368303709:web:e71f7abc063e78224b35b4"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>

<script>
// Global variables
let currentUser = null;
let selectedAgency = null;
let allData = [];
let filteredData = [];
let charts = {};

// Complete demo users with all accounts from UI
const demoUsers = {
    admin: { password: "admin123", role: "admin", name: "Administrator", avatar: "A" },
    viewer: { password: "view123", role: "viewer", name: "Data Viewer", avatar: "V" },
    reporter: { password: "report123", role: "reporter", name: "General Reporter", avatar: "R" },
    npa_reporter: { password: "npa_reporter", role: "reporter", name: "NPA Reporter", avatar: "N", agency: "NPA" },
    moh_reporter: { password: "moh_reporter", role: "reporter", name: "MOH Reporter", avatar: "M", agency: "MOH" },
    zp_reporter: { password: "zp_reporter", role: "reporter", name: "ZP Reporter", avatar: "Z", agency: "ZP" }
};

// Enhanced agencies array
const agencies = [
    { code: 'NPA', name: 'National Prosecution Authority', icon: '⚖️' },
    { code: 'ZP',  name: 'Zambia Police', icon: '👮' },
    { code: 'MOH', name: 'Ministry of Health', icon: '🏥' }
];

// Sample data
const sampleData = [
    {
        'cvw code': 'NPA-CV1',
        'Record Type': 'Victim',
        'Date Reported': new Date('2025-01-04'),
        'District': 'Lusaka',
        'CVW Gender': 'MALE',
        'CVW Age': 5,
        'Crime Type': 'ASSAULT ON A CHILD',
        'Services Rendered': 'MEDICAL REPORT'
    },
    {
        'cvw code': 'MOH-CW5',
        'Record Type': 'Witness',
        'Date Reported': new Date('2025-02-07'),
        'District': 'Katete',
        'CVW Gender': 'MALE',
        'CVW Age': 15,
        'Crime Type': 'RAPE',
        'Services Rendered': 'COUNSELLING'
    },
    {
        'cvw code': 'ZP-CV4',
        'Record Type': 'Victim',
        'Date Reported': new Date('2025-03-11'),
        'District': 'Lusaka',
        'CVW Gender': 'FEMALE',
        'CVW Age': 12,
        'Crime Type': 'RAPE',
        'Services Rendered': 'MEDICAL + COUNSELLING'
    },
    {
        'cvw code': 'NPA-CV2',
        'Record Type': 'Victim',
        'Date Reported': new Date('2025-01-15'),
        'District': 'Ndola',
        'CVW Gender': 'FEMALE',
        'CVW Age': 8,
        'Crime Type': 'DEFILEMENT',
        'Services Rendered': 'LEGAL AID'
    },
    {
        'cvw code': 'MOH-CW3',
        'Record Type': 'Witness',
        'Date Reported': new Date('2025-02-20'),
        'District': 'Kitwe',
        'CVW Gender': 'MALE',
        'CVW Age': 10,
        'Crime Type': 'CHILD ABUSE',
        'Services Rendered': 'PSYCHOSOCIAL SUPPORT'
    },
    {
        'cvw code': 'ZP-CV6',
        'Record Type': 'Victim',
        'Date Reported': new Date('2025-03-01'),
        'District': 'Livingstone',
        'CVW Gender': 'FEMALE',
        'CVW Age': 14,
        'Crime Type': 'TRAFFICKING',
        'Services Rendered': 'SHELTER'
    }
];

// Chart colors
const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];

// Firebase helper functions (removed - offline only)
// All functionality now works purely offline with localStorage

// Fill login form helper (for demo buttons) - MUST BE DEFINED FIRST
window.fillLogin = function(username, password) {
    document.getElementById('username').value = username;
    document.getElementById('password').value = password;
};


// ===== Admin Management Functions =====
window.promptResetPassword = function(identifier) {
  if (currentUser.role !== 'admin') {
    showNotification('Only Administrators can reset passwords', 'error');
    return;
  }
  const newPassword = prompt(`Enter a new password for user: ${identifier}`);
  if (!newPassword) return;
  updateUserPassword(identifier, newPassword);
};

window.updateUserPassword = function(identifier, newPassword) {
  if (navigator.onLine && auth.currentUser && !currentUser.offline) {
    showNotification(`Use Firebase Admin SDK or Console to reset password for ${identifier}`, 'warning');
  } else {
    if (demoUsers[identifier]) {
      demoUsers[identifier].password = newPassword;
      showNotification(`Password updated locally for ${identifier}`, 'success');
    } else {
      showNotification(`User "${identifier}" not found in demo list`, 'error');
    }
  }
};
// ===== End Admin Management Functions =====


// Smart email conversion for Firebase compatibility
function convertToFirebaseEmail(username) {
    // If already contains @, return as-is
    if (username.includes('@')) {
        return username;
    }
    // Convert simple usernames to Firebase-compatible emails
    return username + '@cvw.org';
}

// Hybrid Firebase + Offline login function
window.handleLogin = function() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const errorDiv = document.getElementById('loginError');
    
    console.log('Attempting login for:', username);
    
    // Validate input
    if (!username || !password) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Please enter both username and password';
        return;
    }
    
    // Check if Firebase is available
    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
        console.log('Firebase available, attempting Firebase login...');
        
        // Convert username to Firebase email format if needed
        const firebaseEmail = convertToFirebaseEmail(username);
        console.log('Trying Firebase login with email:', firebaseEmail);
        
        // Try Firebase authentication
        firebase.auth().signInWithEmailAndPassword(firebaseEmail, password)
            .then(userCredential => {
                console.log('Firebase login successful');
                currentUser = {
                    uid: userCredential.user.uid,
                    email: userCredential.user.email,
                    username: username,
                    name: userCredential.user.displayName || username,
                    role: 'admin', // Default role, will be overridden by Firestore data
                    avatar: username.charAt(0).toUpperCase(),
                    offline: false
                };
                
                // Try to get user profile from Firestore
                if (db) {
                    db.collection("users").doc(currentUser.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                const userData = doc.data();
                                currentUser.role = userData.role || 'admin';
                                currentUser.name = userData.name || currentUser.name;
                                currentUser.agency = userData.agency || null;
                            }
                            
                            showDashboard();
          listenToUsers();
                            errorDiv.style.display = 'none';
                            showNotification(`Welcome, ${currentUser.name}! (Online)`, 'success');
                        })
                        .catch(error => {
                            console.warn('Could not load user profile from Firestore:', error);
                            showDashboard();
          listenToUsers();
                            errorDiv.style.display = 'none';
                            showNotification(`Welcome, ${currentUser.name}! (Online - No Profile)`, 'success');
                        });
                } else {
                    showDashboard();
          listenToUsers();
                    errorDiv.style.display = 'none';
                    showNotification(`Welcome, ${currentUser.name}! (Online)`, 'success');
                }
            })
            .catch(error => {
                console.warn("Firebase login failed, trying offline fallback:", error.message);
                tryOfflineLogin(username, password, errorDiv);
            });
    } else {
        console.log('Firebase not available, using offline mode...');
        tryOfflineLogin(username, password, errorDiv);
    }
};

// Separate function for offline login logic
function tryOfflineLogin(username, password, errorDiv) {
    console.log('Attempting offline login for:', username);
    
    // Check demo users (offline fallback)
    if (demoUsers[username] && demoUsers[username].password === password) {
        currentUser = { ...demoUsers[username] };
        currentUser.username = username;
        currentUser.offline = true;
        showDashboard();
          listenToUsers();
        errorDiv.style.display = 'none';
        showNotification(`Welcome, ${currentUser.name}! (Offline Demo)`, 'success');
        console.log('Offline login successful for:', username);
    } else {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Invalid login credentials';
        console.log('Login failed for:', username);
    }
}

// Added the missing showDashboard function
function showDashboard() {
    console.log('Showing dashboard for user:', currentUser);
    
    // Hide login screen
    document.getElementById('loginScreen').classList.add('hidden');
    
    // Show main dashboard
    document.getElementById('mainDashboard').classList.remove('hidden');
    
    // Update user info in the dashboard
    document.getElementById('userAvatar').textContent = currentUser.avatar || currentUser.name.charAt(0);
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = `${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} Account`;
    
    // Update connection status
    updateConnectionStatus();
    
    // Initialize data
    allData = [...sampleData];
    filteredData = [...allData];
    
    // Update UI based on user role
    updateUIBasedOnRole();
    
    // Initialize dashboard components
    updateKPIs();
    updateStatistics();
    updateTable();
    createCharts();
    updateFilterSummary();
}

// Connection status management
function updateConnectionStatus() {
    const statusElement = document.getElementById('connectionStatus');
    const dotElement = document.getElementById('statusDot');
    const textElement = document.getElementById('statusText');
    
    if (navigator.onLine && !currentUser.offline) {
        // Online status
        statusElement.style.backgroundColor = '#d1fae5';
        statusElement.style.color = '#059669';
        statusElement.style.border = '1px solid #10b981';
        dotElement.style.backgroundColor = '#10b981';
        textElement.textContent = 'Online';
    } else {
        // Offline status
        statusElement.style.backgroundColor = '#fef3c7';
        statusElement.style.color = '#d97706';
        statusElement.style.border = '1px solid #f59e0b';
        dotElement.style.backgroundColor = '#f59e0b';
        textElement.textContent = 'Offline Mode';
    }
}

// Monitor connection changes
function setupConnectionMonitoring() {
    window.addEventListener('online', () => {
        console.log('Connection restored');
        if (currentUser) {
            updateConnectionStatus();
            showNotification('Connection restored - now online', 'success');
        }
    });

    window.addEventListener('offline', () => {
        console.log('Connection lost');
        if (currentUser) {
            updateConnectionStatus();
            showNotification('Connection lost - switched to offline mode', 'warning');
        }
    });
}



function updateUIBasedOnRole() {
    const dashboardControls = document.getElementById('dashboardControlsSection');
    const exportReports = document.getElementById('exportReportsSection');
    const agencySection = document.getElementById('agencySection');
    const reporterActions = document.getElementById('reporterActionsSection');
    const filtersSection = document.getElementById('filtersSection');
    const kpiSection = document.getElementById('kpiSection');
    const chartsSection = document.getElementById('chartsSection');
    const tableSection = document.getElementById('tableSection');
    const searchSection = document.getElementById('searchSection');

    // Hide everything by default
    if (dashboardControls) dashboardControls.classList.add('hidden');
    if (exportReports) exportReports.classList.add('hidden');
    if (agencySection) agencySection.classList.add('hidden');
    if (reporterActions) reporterActions.classList.add('hidden');
    if (filtersSection) filtersSection.classList.add('hidden');
    if (kpiSection) kpiSection.classList.add('hidden');
    if (chartsSection) chartsSection.classList.add('hidden');
    if (tableSection) tableSection.classList.add('hidden');
    if (searchSection) searchSection.classList.add('hidden');

    if (currentUser.role === 'admin') {
        if (dashboardControls) dashboardControls.classList.remove('hidden');
        if (filtersSection) filtersSection.classList.remove('hidden');
        if (kpiSection) kpiSection.classList.remove('hidden');
        if (chartsSection) chartsSection.classList.remove('hidden');
        if (tableSection) tableSection.classList.remove('hidden');
        if (searchSection) searchSection.classList.remove('hidden');
    } else if (currentUser.role === 'viewer') {
        if (exportReports) exportReports.classList.remove('hidden');
        if (filtersSection) filtersSection.classList.remove('hidden');
        if (kpiSection) kpiSection.classList.remove('hidden');
        if (chartsSection) chartsSection.classList.remove('hidden');
        if (tableSection) tableSection.classList.remove('hidden');
        if (searchSection) searchSection.classList.remove('hidden');
    } else if (currentUser.role === 'reporter') {
        if (currentUser.agency) {
            selectedAgency = currentUser.agency;
            if (reporterActions) reporterActions.classList.remove('hidden');
            const nameEl = document.getElementById('currentAgencyName');
            const codeEl = document.getElementById('currentAgencyCode');
            if (nameEl) nameEl.textContent = getAgencyFullName(currentUser.agency);
            if (codeEl) codeEl.textContent = currentUser.agency;
        } else {
            if (agencySection) agencySection.classList.remove('hidden');
        }
        // Reporter can only add new records now (no search)
    }
}



function selectAgency(agencyCode) {
    selectedAgency = agencyCode;
    
    // Update visual selection
    document.querySelectorAll('.agency-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    event.target.closest('.agency-card').classList.add('selected');
    
    // Show reporter actions section
    const reporterActionsSection = document.getElementById('reporterActionsSection');
    reporterActionsSection.classList.remove('hidden');
    
    // Update agency info
    document.getElementById('currentAgencyName').textContent = getAgencyFullName(agencyCode);
    document.getElementById('currentAgencyCode').textContent = agencyCode;
    
    showNotification(`Selected agency: ${getAgencyFullName(agencyCode)}`, 'success');
}

function getAgencyFullName(agencyCode) {
    const agency = agencies.find(a => a.code === agencyCode);
    return agency ? agency.name : agencyCode;
}

// Fill login form function
window.fillLogin = function(username, password) {
    document.getElementById('username').value = username;
    document.getElementById('password').value = password;
};

// Logout function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        selectedAgency = null;
        
        // Clear all filters and search states
        clearAllFiltersAndSearch();
        
        // Show login screen
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainDashboard').classList.add('hidden');
        
        // Clear login form
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        
        // Clear error message
        document.getElementById('loginError').style.display = 'none';
        
        showNotification('Logged out successfully', 'info');
        console.log('User logged out');
    }
}

function clearAllFiltersAndSearch() {
    // Clear all filter selections
    const filterSelectors = [
        'districtFilter', 'recordTypeFilter', 'crimeTypeFilter', 
        'genderFilter', 'ageRangeFilter', 'dateRangeFilter'
    ];
    
    filterSelectors.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.value = '';
        }
    });
    
    // Clear search input and results
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const searchSection = document.getElementById('searchSection');
    
    if (searchInput) searchInput.value = '';
    if (searchResults) {
        searchResults.style.display = 'none';
        searchResults.innerHTML = '';
    }
    if (searchSection) {
        searchSection.classList.add('hidden');
    }
    
    // Hide filter summary
    const filterSummary = document.getElementById('filterSummary');
    if (filterSummary) {
        filterSummary.style.display = 'none';
    }
    
    // Reset filtered data to all data
    filteredData = [...allData];
}

// Show notification function
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    console.log(`Notification (${type}):`, message);
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

// Update KPIs function
function updateKPIs() {
    const total = filteredData.length;
    const victims = filteredData.filter(d => d['Record Type'] === 'Victim').length;
    const witnesses = filteredData.filter(d => d['Record Type'] === 'Witness').length;
    const avgAge = total > 0 ? filteredData.reduce((sum, d) => sum + d['CVW Age'], 0) / total : 0;

    document.getElementById('totalCases').textContent = total;
    document.getElementById('victimCases').textContent = victims;
    document.getElementById('witnessCases').textContent = witnesses;
    document.getElementById('avgAge').textContent = Math.round(avgAge * 10) / 10;
}

// Update statistics function
function updateStatistics() {
    const total = filteredData.length;
    if (total === 0) return;

    // District analysis
    const districtCounts = {};
    filteredData.forEach(d => {
        districtCounts[d.District] = (districtCounts[d.District] || 0) + 1;
    });
    const topDistrict = Object.keys(districtCounts).reduce((a, b) => districtCounts[a] > districtCounts[b] ? a : b);

    // Crime analysis
    const crimeCounts = {};
    filteredData.forEach(d => {
        crimeCounts[d['Crime Type']] = (crimeCounts[d['Crime Type']] || 0) + 1;
    });
    const topCrime = Object.keys(crimeCounts).reduce((a, b) => crimeCounts[a] > crimeCounts[b] ? a : b);

    // Service analysis
    const serviceCounts = {};
    filteredData.forEach(d => {
        if (d['Services Rendered']) {
            serviceCounts[d['Services Rendered']] = (serviceCounts[d['Services Rendered']] || 0) + 1;
        }
    });
    const topService = Object.keys(serviceCounts).length > 0 ? 
        Object.keys(serviceCounts).reduce((a, b) => serviceCounts[a] > serviceCounts[b] ? a : b) : 'N/A';

    // Gender analysis
    const femaleCases = filteredData.filter(d => d['CVW Gender'] === 'FEMALE').length;
    const maleCases = filteredData.filter(d => d['CVW Gender'] === 'MALE').length;
    const femalePercent = total > 0 ? Math.round((femaleCases / total) * 100) : 0;
    const malePercent = total > 0 ? Math.round((maleCases / total) * 100) : 0;

    // Update UI
    document.getElementById('topDistrict').textContent = topDistrict;
    document.getElementById('topCrime').textContent = topCrime;
    document.getElementById('topService').textContent = topService;
    document.getElementById('femaleCases').textContent = `${femaleCases} (${femalePercent}%)`;
    document.getElementById('maleCases').textContent = `${maleCases} (${malePercent}%)`;
}

// Update table function
function updateTable() {
    const tbody = document.getElementById('tableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    filteredData.forEach(row => {
        const tr = document.createElement('tr');
        
const servicesBadges = (row['Services Rendered'] || 'N/A')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean)
    .map(s => `<span class="badge-service">${s}</span>`)
    .join(' ');

tr.innerHTML = `
    <td style="font-weight: 600; color: #2c3e50;">${row['cvw code']}</td>
    <td><span class="badge badge-${row['Record Type'].toLowerCase()}">${row['Record Type']}</span></td>
    <td>${row['Date Reported'].toLocaleDateString()}</td>
    <td>${row['District']}</td>
    <td>${row['CVW Gender']}</td>
    <td>${row['CVW Age']}</td>
    <td>${row['Crime Type']}</td>
    <td>${servicesBadges || 'N/A'}</td>
`;

        tbody.appendChild(tr);
    });
}

// Create charts function
function createCharts() {
    try {
        // District chart
        const districtCounts = {};
        filteredData.forEach(d => {
            districtCounts[d.District] = (districtCounts[d.District] || 0) + 1;
        });

        createChart('districtChart', 'bar', {
            labels: Object.keys(districtCounts),
            datasets: [{
                label: 'Cases',
                data: Object.values(districtCounts),
                backgroundColor: colors.slice(0, Object.keys(districtCounts).length),
                borderRadius: 8
            }]
        });

        // Crime type chart
        const crimeCounts = {};
        filteredData.forEach(d => {
            crimeCounts[d['Crime Type']] = (crimeCounts[d['Crime Type']] || 0) + 1;
        });

        createChart('crimeChart', 'doughnut', {
            labels: Object.keys(crimeCounts),
            datasets: [{
                data: Object.values(crimeCounts),
                backgroundColor: colors.slice(0, Object.keys(crimeCounts).length)
            }]
        });

        // Age distribution
        const ageRanges = { '0-5': 0, '6-10': 0, '11-15': 0, '16-18': 0 };
        filteredData.forEach(d => {
            const age = d['CVW Age'];
            if (age <= 5) ageRanges['0-5']++;
            else if (age <= 10) ageRanges['6-10']++;
            else if (age <= 15) ageRanges['11-15']++;
            else ageRanges['16-18']++;
        });

        createChart('ageChart', 'bar', {
            labels: Object.keys(ageRanges),
            datasets: [{
                label: 'Count',
                data: Object.values(ageRanges),
                backgroundColor: colors.slice(0, 4),
                borderRadius: 8
            }]
        });

        // Gender distribution
        const genderCounts = {};
        filteredData.forEach(d => {
            genderCounts[d['CVW Gender']] = (genderCounts[d['CVW Gender']] || 0) + 1;
        });

        createChart('genderChart', 'pie', {
            labels: Object.keys(genderCounts),
            datasets: [{
                data: Object.values(genderCounts),
                backgroundColor: colors.slice(0, Object.keys(genderCounts).length)
            }]
        });

        // Time series
        const monthCounts = {};
        filteredData.forEach(d => {
            const month = d['Date Reported'].toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            monthCounts[month] = (monthCounts[month] || 0) + 1;
        });

        createChart('timeChart', 'line', {
            labels: Object.keys(monthCounts),
            datasets: [{
                label: 'Cases',
                data: Object.values(monthCounts),
                borderColor: colors[0],
                backgroundColor: colors[0] + '30',
                fill: true,
                tension: 0.4
            }]
        });

        // Services distribution
        const servicesCounts = {};
        filteredData.forEach(d => {
            if (d['Services Rendered']) {
                servicesCounts[d['Services Rendered']] = (servicesCounts[d['Services Rendered']] || 0) + 1;
            }
        });

        createChart('servicesChart', 'doughnut', {
            labels: Object.keys(servicesCounts),
            datasets: [{
                data: Object.values(servicesCounts),
                backgroundColor: colors.slice(0, Object.keys(servicesCounts).length)
            }]
        });

    } catch (error) {
        console.error('Error creating charts:', error);
    }
}

function createChart(canvasId, type, data) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }

    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Filter functions
function applyFilters() {
    const district = document.getElementById('districtFilter').value;
    const recordType = document.getElementById('recordTypeFilter').value;
    const crimeType = document.getElementById('crimeTypeFilter').value;
    const gender = document.getElementById('genderFilter').value;
    const ageRange = document.getElementById('ageRangeFilter').value;
    const dateRange = document.getElementById('dateRangeFilter').value;

    filteredData = allData.filter(row => {
        // District filter
        if (district && row.District !== district) return false;
        
        // Record type filter
        if (recordType && row['Record Type'] !== recordType) return false;
        
        // Crime type filter
        if (crimeType && row['Crime Type'] !== crimeType) return false;
        
        // Gender filter
        if (gender && row['CVW Gender'] !== gender) return false;
        
        // Age range filter
        if (ageRange) {
            const age = row['CVW Age'];
            switch (ageRange) {
                case '0-5':
                    if (age < 0 || age > 5) return false;
                    break;
                case '6-10':
                    if (age < 6 || age > 10) return false;
                    break;
                case '11-15':
                    if (age < 11 || age > 15) return false;
                    break;
                case '16-18':
                    if (age < 16 || age > 18) return false;
                    break;
            }
        }
        
        // Date range filter
        if (dateRange) {
            const today = new Date();
            const recordDate = new Date(row['Date Reported']);
            let cutoffDate = new Date();
            
            switch (dateRange) {
                case 'last7days':
                    cutoffDate.setDate(today.getDate() - 7);
                    break;
                case 'last30days':
                    cutoffDate.setDate(today.getDate() - 30);
                    break;
                case 'last3months':
                    cutoffDate.setMonth(today.getMonth() - 3);
                    break;
                case 'last6months':
                    cutoffDate.setMonth(today.getMonth() - 6);
                    break;
                case 'thisyear':
                    cutoffDate = new Date(today.getFullYear(), 0, 1);
                    break;
            }
            
            if (recordDate < cutoffDate) return false;
        }
        
        return true;
    });

    // Update all components automatically
    updateKPIs();
    updateStatistics();
    updateTable();
    createCharts();
    updateFilterSummary();
}

function resetFilters() {
    // Clear all filter selections
    document.getElementById('districtFilter').value = '';
    document.getElementById('recordTypeFilter').value = '';
    document.getElementById('crimeTypeFilter').value = '';
    document.getElementById('genderFilter').value = '';
    document.getElementById('ageRangeFilter').value = '';
    document.getElementById('dateRangeFilter').value = '';
    
    // Reset data
    filteredData = [...allData];
    
    // Update all components
    updateKPIs();
    updateStatistics();
    updateTable();
    createCharts();
    updateFilterSummary();
    
    showNotification('All filters reset', 'info');
}

function updateFilterSummary() {
    const filterSummary = document.getElementById('filterSummary');
    const activeFiltersSpan = document.getElementById('activeFilters');
    const filteredCountSpan = document.getElementById('filteredCount');
    const totalCountSpan = document.getElementById('totalCount');
    
    // Get active filters
    const activeFilters = [];
    
    const district = document.getElementById('districtFilter').value;
    const recordType = document.getElementById('recordTypeFilter').value;
    const crimeType = document.getElementById('crimeTypeFilter').value;
    const gender = document.getElementById('genderFilter').value;
    const ageRange = document.getElementById('ageRangeFilter').value;
    const dateRange = document.getElementById('dateRangeFilter').value;
    
    if (district) activeFilters.push(`District: ${district}`);
    if (recordType) activeFilters.push(`Type: ${recordType}`);
    if (crimeType) activeFilters.push(`Crime: ${crimeType}`);
    if (gender) activeFilters.push(`Gender: ${gender}`);
    if (ageRange) activeFilters.push(`Age: ${ageRange}`);
    if (dateRange) activeFilters.push(`Date: ${dateRange}`);
    
    // Update display
    if (activeFilters.length > 0) {
        filterSummary.style.display = 'block';
        activeFiltersSpan.textContent = activeFilters.join(', ');
        filteredCountSpan.textContent = filteredData.length;
        totalCountSpan.textContent = allData.length;
    } else {
        filterSummary.style.display = 'none';
    }
}

// Modal functions
window.openAddRecord = function() {
    const modal = document.getElementById('addRecordModal');
    modal.style.display = 'flex';
    
    // Set default date to today
    document.getElementById('modalDateReported').value = new Date().toISOString().split('T')[0];
    
    // Generate case ID
    setTimeout(() => {
        generateModalCaseId();
    }, 100);
};

window.closeAddRecordModal = function() {
    const modal = document.getElementById('addRecordModal');
    modal.style.display = 'none';
    
    // Reset form
    document.getElementById('modalCaseId').value = '';
    document.getElementById('modalRecordType').value = '';
    document.getElementById('modalDateReported').value = '';
    document.getElementById('modalDistrict').value = '';
    document.getElementById('modalCvwGender').value = '';
    document.getElementById('modalCvwAge').value = '';
    document.getElementById('modalCrimeType').value = '';
    document.getElementById('modalServicesRendered').value = '';
    document.getElementById('modalAdditionalNotes').value = '';
    
    // Hide messages
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
};

window.generateModalCaseId = function() {
    const recordType = document.getElementById('modalRecordType').value;
    if (!recordType) return;
    
    const agencyCode = currentUser.agency || selectedAgency || 'GEN';
    const typeCode = recordType === 'Victim' ? 'CV' : 'CW';
    
    // Find next available number
    const existingCodes = allData
        .map(d => d['cvw code'])
        .filter(code => code.startsWith(`${agencyCode}-${typeCode}`))
        .map(code => parseInt(code.split(typeCode)[1]) || 0);
    
    const nextNumber = Math.max(0, ...existingCodes) + 1;
    const caseId = `${agencyCode}-${typeCode}${nextNumber}`;
    
    document.getElementById('modalCaseId').value = caseId;
};

window.saveNewRecord = function() {
    const caseId = document.getElementById('modalCaseId').value;
    const recordType = document.getElementById('modalRecordType').value;
    const dateReported = document.getElementById('modalDateReported').value;
    const district = document.getElementById('modalDistrict').value;
    const gender = document.getElementById('modalCvwGender').value;
    const age = document.getElementById('modalCvwAge').value;
    const crimeType = document.getElementById('modalCrimeType').value;
    const services = document.getElementById('modalServicesRendered').value;
    const notes = document.getElementById('modalAdditionalNotes').value;
    
    // Validate required fields
    if (!recordType || !dateReported || !district || !gender || !age || !crimeType) {
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Please fill in all required fields';
        return;
    }
    
    // Create new record
    const newRecord = {
        'cvw code': caseId,
        'Record Type': recordType,
        'Date Reported': new Date(dateReported),
        'District': district,
        'CVW Gender': gender,
        'CVW Age': parseInt(age),
        'Crime Type': crimeType,
        'Services Rendered': services || ''
    };
    
    // Add to data
    allData.push(newRecord);
    filteredData = [...allData];
    
    // Update UI
    updateKPIs();
    updateStatistics();
    updateTable();
    createCharts();
    updateFilterSummary();
    
    // Show success message
    document.getElementById('successMessage').style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
    
    showNotification(`Record ${caseId} added successfully!`, 'success');
    
    // Close modal after delay
    setTimeout(() => {
        closeAddRecordModal();
    }, 2000);
};

// Search functions
window.toggleSearch = function() {
    const searchSection = document.getElementById('searchSection');
    if (searchSection.classList.contains('hidden')) {
        searchSection.classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('searchInput').focus();
        }, 100);
    } else {
        searchSection.classList.add('hidden');
        clearSearch();
    }
};

window.searchRecords = function() {
    const query = document.getElementById('searchInput').value.trim().toUpperCase();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!query) {
        resultsDiv.innerHTML = '<p style="color: #dc2626; padding: 10px;">Please enter a search term</p>';
        resultsDiv.style.display = 'block';
        return;
    }

    const results = allData.filter(record => 
        record['cvw code'].toUpperCase().includes(query) ||
        record['District'].toUpperCase().includes(query) ||
        record['Crime Type'].toUpperCase().includes(query) ||
        record['CVW Gender'].toUpperCase().includes(query) ||
        (record['Services Rendered'] && record['Services Rendered'].toUpperCase().includes(query))
    );

    if (results.length === 0) {
        resultsDiv.innerHTML = `<p style="color: #dc2626; padding: 10px;">No records found for: "${query}"</p>`;
    } else {
        let html = `<h4 style="color: #2c3e50; margin-bottom: 15px; padding: 10px;">Found ${results.length} record(s):</h4>`;
        results.forEach((record) => {
            html += `
                <div class="result-item" style="margin-bottom: 10px;">
                    <strong style="color: #667eea;">${record['cvw code']}</strong> - 
                    <span class="badge badge-${record['Record Type'].toLowerCase()}" style="margin: 0 5px;">${record['Record Type']}</span> - 
                    <strong>${record['District']}</strong>
                    <br><small style="color: #6c757d;">${record['Crime Type']} | Age: ${record['CVW Age']} | Gender: ${record['CVW Gender']} | ${record['Date Reported'].toLocaleDateString()}</small>
                    
      <br><strong style="color: #28a745;">Services: ${record['Services Rendered'] || 'None'}</strong>
      ${
        currentUser && currentUser.role === 'reporter' 
          ? `<br><button class="btn btn-sm btn-success" onclick="openAddServiceModal('${record['cvw code']}')">+ Add Service</button>`
          : ''
      }

                </div>
            `;
        });
        resultsDiv.innerHTML = html;
    }
    
    resultsDiv.style.display = 'block';
};

window.clearSearch = function() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').style.display = 'none';
};

// Export functions
window.exportPDF = function() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(18);
        doc.text("CVW Case Reports - Zambia", 14, 20);
        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);

        // Summary
        const dataToExport = filteredData.length > 0 ? filteredData : allData;
        const total = dataToExport.length;
        const victims = dataToExport.filter(d => d['Record Type'] === 'Victim').length;
        const witnesses = dataToExport.filter(d => d['Record Type'] === 'Witness').length;
        const avgAge = total > 0 ? dataToExport.reduce((sum, d) => sum + d['CVW Age'], 0) / total : 0;

        doc.setFontSize(14);
        doc.text("Summary Statistics:", 14, 45);
        doc.setFontSize(11);
        doc.text(`Total Cases: ${total}`, 14, 55);
        doc.text(`Victim Cases: ${victims}`, 14, 62);
        doc.text(`Witness Cases: ${witnesses}`, 14, 69);
        doc.text(`Average Age: ${avgAge.toFixed(1)} years`, 14, 76);

        // Table of cases
        const rows = dataToExport.map(record => [
            record['cvw code'],
            record['Record Type'],
            record['District'],
            record['CVW Age'],
            record['CVW Gender'],
            record['Crime Type'],
            record['Services Rendered'] || 'N/A',
            record['Date Reported'].toLocaleDateString()
        ]);

        doc.autoTable({
            head: [['Case ID','Type','District','Age','Gender','Crime','Services','Date']],
            body: rows,
            startY: 90,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [102, 126, 234] }
        });

        doc.save(`CVW_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification(`PDF exported successfully! ${rows.length} records included.`, 'success');
    } catch (error) {
        console.error("PDF export error:", error);
        showNotification("Error generating PDF. Please try again.", "error");
    }
};

window.exportCSV = function() {
    try {
        const dataToExport = filteredData.length > 0 ? filteredData : allData;
        
        if (dataToExport.length === 0) {
            showNotification('No data to export', 'error');
            return;
        }
        
        const headers = ['Case_ID', 'Record_Type', 'Date_Reported', 'District', 'Gender', 'Age', 'Crime_Type', 'Services_Rendered'];
        const rows = dataToExport.map(record => [
            record['cvw code'],
            record['Record Type'],
            record['Date Reported'].toLocaleDateString(),
            record['District'],
            record['CVW Gender'],
            record['CVW Age'],
            record['Crime Type'],
            record['Services Rendered'] || 'N/A'
        ]);
        
        const csvContent = [headers, ...rows]
            .map(row => row.map(field => {
                const stringField = String(field);
                if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                    return `"${stringField.replace(/"/g, '""')}"`;
                }
                return stringField;
            }).join(','))
            .join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `CVW_Data_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification(`CSV exported successfully! ${dataToExport.length} records included.`, 'success');
    } catch (error) {
        console.error('CSV export error:', error);
        showNotification('Error generating CSV file. Please try again.', 'error');
    }
};

window.exportFilteredData = function() {
    exportCSV();
};

// User management functions
window.manageUsers = function() {
    if (!currentUser || currentUser.role !== 'admin') {
        showNotification('Access denied: Only administrators can manage users', 'error');
        return;
    }
    
    const modal = document.getElementById('userMgmtModal');
    modal.style.display = 'flex';
    updateUsersList();
};

window.closeUserMgmtModal = function() {
    const modal = document.getElementById('userMgmtModal');
    modal.style.display = 'none';
};

// Hybrid Firebase + Offline user creation

window.addNewUser = function() {
  const usernameInput = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  const role = document.getElementById('newUserRole').value;
  const name = document.getElementById('newUserName').value.trim();
  const agency = document.getElementById('newUserAgency').value;

  console.log("addNewUser called with:", usernameInput, role, name, agency);

  if (!usernameInput || !password || !role || !name || !agency) {
    showNotification("Please fill in all required fields including agency", "error");
    return;
  }

  let email = usernameInput.includes('@') ? usernameInput : usernameInput + '@cvw.org';

  auth.createUserWithEmailAndPassword(email, password)
    .then(userCredential => {
      const uid = userCredential.user.uid;
      return db.collection("users").doc(uid).set({
        email, role, name, agency
      });
    })
    .then(() => {
      showNotification(`User "${email}" added with role ${role} (${agency})`, "success");
      if (typeof updateUsersList === "function") updateUsersList();
    })
    .catch(error => {
      console.error("User creation failed, fallback to demo:", error);
      window.demoUsers[usernameInput] = {
        password, role, name, agency,
        avatar: name.charAt(0).toUpperCase()
      };
      if (typeof updateUsersList === "function") updateUsersList();
      showNotification(`User "${usernameInput}" added locally with ${role} (${agency})`, "warning");
    });

  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('newUserRole').value = '';
  document.getElementById('newUserName').value = '';
  document.getElementById('newUserAgency').value = '';
};


// Helper function to create offline user
function createOfflineUser(username, password, role, name) {
    // Add user to demo users (offline fallback)
    demoUsers[username] = {
        password: password,
        role: role,
        name: name,
        avatar: name.charAt(0).toUpperCase()
    };
    
    updateUsersList();
    clearUserForm();
    showNotification(`User "${username}" added locally (offline mode) with ${role} role`, "warning");
}

// Helper function to clear user form
function clearUserForm() {
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newUserRole').value = '';
    document.getElementById('newUserName').value = '';
}

// Enhanced users list rendering
function updateUsersList() {
    const usersList = document.getElementById('usersList');
    if (!usersList) return;
    
    usersList.innerHTML = '';

    // Check if we should load from Firebase or show demo users
    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0 && !currentUser.offline && db) {
        console.log('Loading users from Firebase...');
        
        db.collection("users").get()
            .then(snapshot => {
                if (snapshot.empty) {
                    console.log('No Firebase users found, showing demo users');
                    renderDemoUsers(usersList);
                    return;
                }
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userDiv = document.createElement('div');
                    userDiv.style.cssText = 'padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; display: flex; justify-content: space-between; align-items: center;';
                    
                    userDiv.innerHTML = `
                        <div>
                            <div style="font-weight: 600; color: #2c3e50;">${user.name || user.username || 'Unknown'}</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">Email: ${user.email} | Role: ${user.role}</div>
                            <div style="font-size: 0.8rem; color: #adb5bd;">UID: ${doc.id}</div>
                        </div>
                        <div>
                            ${user.email !== 'admin@cvw.org' ? `<button onclick="deleteFirebaseUser('${doc.id}', '${user.email}')" class="btn btn-sm" style="background: #dc3545; color: white;">Delete</button>` : '<span style="color: #28a745;">Protected</span>'}
                        </div>
                    `;
                    
                    usersList.appendChild(userDiv);
                });
            })
            .catch(error => {
                console.error("Error fetching Firebase users:", error);
                showNotification("Could not fetch online users, showing offline list", "warning");
                renderDemoUsers(usersList);
            });
    } else {
        console.log('Showing demo users (offline mode)');
        renderDemoUsers(usersList);
    }
}

// Helper to render demo users list
function renderDemoUsers(usersList) {
    Object.entries(demoUsers).forEach(([username, user]) => {
        const userDiv = document.createElement('div');
        userDiv.style.cssText = 'padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; display: flex; justify-content: space-between; align-items: center;';
        
        userDiv.innerHTML = `
            <div>
                <div style="font-weight: 600; color: #2c3e50;">${user.name}</div>
                <div style="font-size: 0.9rem; color: #6c757d;">Username: ${username} | Role: ${user.role}</div>
                <div style="font-size: 0.8rem; color: #adb5bd;">Demo Account</div>
            </div>
            <div>
                ${username !== 'admin' ? `<button onclick="deleteDemoUser('${username}')" class="btn btn-sm" style="background: #dc3545; color: white;">Delete</button>` : '<span style="color: #28a745;">Protected</span>'}
            </div>
        `;
        
        usersList.appendChild(userDiv);
    });
}

// Firebase user deletion
window.deleteFirebaseUser = function(uid, email) {
    if (!currentUser || currentUser.role !== 'admin') {
        showNotification('Access denied: Only administrators can delete users', 'error');
        return;
    }

    if (!confirm(`Are you sure you want to delete user "${email}"?`)) {
        return;
    }

    if (db) {
        db.collection("users").doc(uid).delete()
            .then(() => {
                showNotification(`User "${email}" deleted from Firestore`, 'success');
                updateUsersList();
            })
            .catch(error => {
                console.error("Error deleting Firebase user:", error);
                showNotification(`Could not delete user: ${error.message}`, "error");
            });
    }
};

// Demo user deletion
window.deleteDemoUser = function(username) {
    if (username === 'admin') {
        showNotification('Cannot delete the administrator account', 'error');
        return;
    }

    if (confirm(`Are you sure you want to delete user "${username}"?`)) {
        delete demoUsers[username];
        updateUsersList();
        showNotification(`User "${username}" deleted from demo accounts`, 'success');
    }
};

// Legacy delete function for backward compatibility
window.deleteUser = function(identifier) {
    // Try to determine if this is a Firebase UID or demo username
    if (identifier.length > 15) {
        // Likely a Firebase UID
        deleteFirebaseUser(identifier, 'Unknown Email');
    } else {
        // Likely a demo username
        deleteDemoUser(identifier);
    }
};

window.manageAgencies = function() {
    if (!currentUser || currentUser.role !== 'admin') {
        showNotification('Access denied: Only administrators can manage agencies', 'error');
        return;
    }
    
    const modal = document.getElementById('agencyModal');
    if (modal) {
        modal.style.display = 'flex';
        updateAgencyList();
    } else {
        // Create agency management modal if it doesn't exist
        createAgencyModal();
    }
};

function createAgencyModal() {
    const modalHTML = `
        <div class="modal-overlay" id="agencyModal" style="display: flex;">
            <div class="modal-container">
                <div class="modal-header">
                    <h2>🏢 Manage Agencies</h2>
                    <button class="modal-close" onclick="closeAgencyModal()">×</button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">Add New Agency</h3>
                        <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: end;">
                            <div class="form-group">
                                <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Agency Code</label>
                                <input id="newAgencyCode" maxlength="5" placeholder="e.g., EDU" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">Agency Name</label>
                                <input id="newAgencyName" placeholder="e.g., Ministry of Education" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" type="text"/>
                            </div>
                            <button class="btn btn-success" onclick="addAgency()" style="height: 48px;">+ Add Agency</button>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">Current Agencies</h3>
                        <div id="agencyList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    updateAgencyList();
}

window.closeAgencyModal = function() {
    const modal = document.getElementById('agencyModal');
    if (modal) {
        modal.style.display = 'none';
    }
};

window.addAgency = function() {
    const agencyCode = document.getElementById('newAgencyCode').value.trim().toUpperCase();
    const agencyName = document.getElementById('newAgencyName').value.trim();

    if (!agencyCode || !agencyName) {
        showNotification("Please fill in all agency fields", "error");
        return;
    }

    // Check if agency code already exists
    if (agencies.find(a => a.code === agencyCode)) {
        showNotification("Agency code already exists", "error");
        return;
    }

    // Add new agency
    agencies.push({
        code: agencyCode,
        name: agencyName,
        icon: '🏢'
    });

    // Clear form
    document.getElementById('newAgencyCode').value = '';
    document.getElementById('newAgencyName').value = '';

    // Update displays
    updateAgencyList();
    updateAgencyGrid();

        updateAgencyDropdown();
    updateEditUserAgencyDropdown();
showNotification(`Agency "${agencyName}" added successfully`, "success");
};

function updateAgencyList() {
    const agencyList = document.getElementById('agencyList');
    if (!agencyList) return;
    
    agencyList.innerHTML = '';
    
    agencies.forEach(agency => {
        const agencyDiv = document.createElement('div');
        agencyDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white;';
        
        const coreAgencies = ['NPA', 'MOH', 'ZP'];
        const isCore = coreAgencies.includes(agency.code);
        
        agencyDiv.innerHTML = `
            <div>
                <div style="font-weight: bold; color: #2c3e50; font-family: monospace;">${agency.code}</div>
                <div style="color: #6c757d; margin-top: 5px;">${agency.name}</div>
                ${isCore ? '<small style="color: #28a745; font-weight: bold;">Core Agency</small>' : ''}
            </div>
            <div>
                ${!isCore ? `<button onclick="deleteAgency('${agency.code}')" class="btn btn-sm" style="background: #dc3545; color: white;">Delete</button>` : '<span style="color: #28a745;">Protected</span>'}
            </div>
        `;
        
        agencyList.appendChild(agencyDiv);
    });
}

function updateAgencyGrid() {
    const agencyGrid = document.getElementById('agencyGridContainer');
    if (!agencyGrid) return;
    
    agencyGrid.innerHTML = '';
    
    agencies.forEach(agency => {
        const agencyCard = document.createElement('div');
        agencyCard.className = 'agency-card';
        agencyCard.onclick = () => selectAgency(agency.code);
        
        agencyCard.innerHTML = `
            <div class="agency-icon">${agency.icon}</div>
            <div class="agency-name">${agency.name}</div>
            <div class="agency-code">${agency.code}</div>
            <div class="agency-display">${agency.code} - ${agency.name}</div>
        `;
        
        agencyGrid.appendChild(agencyCard);
    });
}

window.deleteAgency = function(agencyCode) {
    // Prevent deletion of core agencies
    const coreAgencies = ['NPA', 'MOH', 'ZP'];
    if (coreAgencies.includes(agencyCode)) {
        showNotification('Cannot delete core agencies (NPA, MOH, ZP)', 'error');
        return;
    }

    if (confirm(`Are you sure you want to delete agency "${agencyCode}"?`)) {
        const agencyIndex = agencies.findIndex(agency => agency.code === agencyCode);
        if (agencyIndex !== -1) {
            const deletedAgency = agencies[agencyIndex];
            agencies.splice(agencyIndex, 1);
            
            // Update displays
            updateAgencyList();
            updateAgencyGrid();
            
                updateAgencyDropdown();
    updateEditUserAgencyDropdown();
showNotification(`Agency "${deletedAgency.name}" has been deleted`, 'success');
        }
    }
};

// Add event listeners when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    listenToRoles();
    loadAgenciesFromFirebase();
    loadCaseRecordsFromFirebase();
    listenToCases();
    listenToUsers();
    listenToAgencies();
    updateAgencyDropdown();
        updateEditUserAgencyDropdown();
console.log('CVW Dashboard loaded and ready');
    
    // Setup connection monitoring
    setupConnectionMonitoring();
    
    // Enter key support for login
    document.getElementById('username').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });
    
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });
    
    // Modal close on background click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            if (e.target.id === 'addRecordModal') {
                closeAddRecordModal();
            } else if (e.target.id === 'userMgmtModal') {
                closeUserMgmtModal();
            }
        }
    });

    // Escape key to close modals
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const addModal = document.getElementById('addRecordModal');
            const userModal = document.getElementById('userMgmtModal');
            
            if (addModal && addModal.style.display === 'flex') {
                closeAddRecordModal();
            }
            if (userModal && userModal.style.display === 'flex') {
                closeUserMgmtModal();
            }
        }
    });

    // Enter key in search
    document.addEventListener('keypress', function(e) {
        if (e.target.id === 'searchInput' && e.key === 'Enter') {
            searchRecords();
        }
    });
    
    // Focus on username field
    document.getElementById('username').focus();
});

async function saveNewService() {
    const modal = document.getElementById('addServiceModal');
    const recordId = modal.getAttribute('data-record-id');
    const select = document.getElementById('newServiceInput');
    const selected = Array.from(select.selectedOptions).map(o => o.value);

    if (!selected.length) {
        showNotification('Please select at least one service', 'error');
        return;
    }

    try {
        if (db && !currentUser.offline) {
            await db.collection("caseRecords").doc(recordId).update({
                servicesRendered: firebase.firestore.FieldValue.arrayUnion(...selected),
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Service(s) added to ${recordId}`, 'success');
        } else {
            // Offline fallback
            const localRecord = allData.find(r => r['cvw code'] === recordId);
            if (localRecord) {
                if (!localRecord['Services Rendered']) localRecord['Services Rendered'] = '';
                const currentServices = localRecord['Services Rendered'].split(',').map(s => s.trim()).filter(Boolean);
                selected.forEach(s => {
                    if (!currentServices.includes(s)) currentServices.push(s);
                });
                localRecord['Services Rendered'] = currentServices.join(', ');
            }
            showNotification(`Service(s) saved locally for ${recordId}`, 'info');
        }
    } catch (error) {
        console.error("Error saving service:", error);
        showNotification("Error saving service. Try again.", "error");
    }

    closeAddServiceModal();
    if (typeof refreshDashboardData === 'function') refreshDashboardData();
    if (typeof searchRecords === 'function') searchRecords();
}


function openAddServiceModal(recordId) {
    const modal = document.getElementById('addServiceModal');
    if (!modal) {
        console.error('Add Service modal not found');
        return;
    }
    modal.style.display = 'flex'; // Show modal
    modal.setAttribute('data-record-id', recordId);
    console.log('Opening Add Service modal for record:', recordId);
}
function closeAddServiceModal() {
    const modal = document.getElementById('addServiceModal');
    if (modal) modal.style.display = 'none';
}

</script>



  </div>
</div>


<!-- Edit User Modal -->
<div class="modal-overlay" id="editUserModal" style="display:none;">
  <div class="modal-container">
    <div class="modal-header">
      <h2>✏️ Edit User</h2>
      <button class="modal-close" onclick="closeEditUserModal()">×</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editUserId"/>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="editUserName" class="form-input"/>
      </div>
      <div class="form-group">
        <label>Role</label>
        <select id="editUserRole" class="form-input"></select>
      </div>
      <div class="form-group">
        <label>Agency</label>
        <select id="editUserAgency" class="form-input"></select>
      </div>
      <div class="form-group">
        <label>New Password (leave blank to keep current)</label>
        <input type="password" id="editUserPassword" class="form-input"/>
      </div>
    </div>
    <div style="padding:20px; display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn" onclick="closeEditUserModal()" style="background:#6c757d; color:white;">Cancel</button>
      <button class="btn btn-success" onclick="saveUserEdits()">Save Changes</button>
    </div>
  </div>
</div>


<!-- Add Service Modal -->
<div id="addServiceModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div class="modal-container" style="background:white; padding:20px; border-radius:8px; max-width:400px; width:100%;">
    <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Add Service</h2>
      <button class="modal-close" onclick="closeAddServiceModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">×</button>
    </div>
    <div class="modal-body" style="margin-top:15px;">
      <label for="newServiceInput" style="font-weight:bold; margin-bottom:8px; display:block;">Select Service</label>
      
<select id="newServiceInput" multiple style="width:100%; padding:10px; margin-bottom:15px; height:150px;">
  <option value="MEDICAL REPORT">Medical Report</option>
  <option value="COUNSELLING">Counselling</option>
  <option value="LEGAL AID">Legal Aid</option>
  <option value="PSYCHOSOCIAL SUPPORT">Psychosocial Support</option>
  <option value="SHELTER">Shelter</option>
  <option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
  <option value="LEGAL + COUNSELLING">Legal + Counselling</option>
  <option value="REFERRAL">Referral</option>
  <option value="FOLLOW-UP">Follow-up</option>
  <option value="REHABILITATION">Rehabilitation</option>
  <option value="FAMILY SUPPORT">Family Support</option>
  <option value="EMERGENCY CARE">Emergency Care</option>
</select>

      <div style="display:flex; justify-content:space-between;">
        <button class="btn btn-success" onclick="saveNewService()" style="background:#28a745; color:white; padding:6px 12px; border:none; border-radius:4px;">Save</button>
        <button class="btn" onclick="closeAddServiceModal()" style="background:#6c757d; color:white; padding:6px 12px; border:none; border-radius:4px;">Cancel</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
