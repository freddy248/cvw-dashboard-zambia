<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CVW Dashboard - Zambia (Full)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
  :root { --pri:#5b6cf9; --pri2:#764ba2; --bg:#f4f7fb; --card:#fff; --muted:#6b7280; }
  *{box-sizing:border-box} body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;min-height:100vh;color:#111827}
  .container{max-width:1200px;margin:0 auto;padding:20px}
  .card{background:rgba(255,255,255,.98);border-radius:16px;box-shadow:0 16px 36px rgba(0,0,0,.08);padding:20px}
  .hidden{display:none !important}
  .login{max-width:420px;margin:10vh auto}
  h1,h2{margin:0 0 8px} .subtitle{color:#6b7280;margin-bottom:16px}
  input,select{width:100%;padding:12px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-pri{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  .btn-dan{background:#ef4444;color:#fff} .btn-sec{background:#111827;color:#fff}
  .grid{display:grid;gap:12px} .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))} .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:900px){.g4{grid-template-columns:repeat(2,minmax(0,1fr))} .g3{grid-template-columns:repeat(1,minmax(0,1fr))}}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:14px}
  th{text-align:left;color:#374151} .pill{padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
  .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .note{position:fixed;top:16px;right:16px;padding:12px 14px;border-radius:10px;display:none;font-weight:600}
  .note.success{background:#d1fae5;color:#065f46;border:1px solid #10b981}
  .note.error{background:#fee2e2;color:#991b1b;border:1px solid #ef4444}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
  .modal .sheet{background:#fff;border-radius:14px;max-width:560px;width:96%;padding:18px}
</style>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBo0jRzfh3DVNdCkPjXXgwvi2cfacXE1Ok",
  authDomain: "cvw-dashboard-zambia.firebaseapp.com",
  projectId: "cvw-dashboard-zambia",
  storageBucket: "cvw-dashboard-zambia.appspot.com",
  messagingSenderId: "905368303709",
  appId: "1:905368303709:web:e71f7abc063e78224b35b4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>
</head>
<body>
<div class="container">
  <div id="login" class="card login">
    <h1>ðŸ“Š CVW Dashboard</h1>
    <p class="subtitle">Zambia Child Victim & Witness Analytics</p>
    <div id="loginError" class="note error" style="display:none">Invalid credentials</div>
    <div class="grid">
      <input id="username" placeholder="Username"/>
      <input id="password" placeholder="Password" type="password"/>
      <button class="btn btn-pri" onclick="handleLogin()">ðŸš€ Login</button>
    </div>
    <div class="card" style="margin-top:12px">
      <b>Demo accounts</b>
      <div class="grid g3" style="margin-top:8px">
        <button class="btn" onclick="fillLogin('admin','admin123')">admin/admin123</button>
        <button class="btn" onclick="fillLogin('viewer','view123')">viewer/view123</button>
        <button class="btn" onclick="fillLogin('reporter','report123')">reporter/report123</button>
        <button class="btn" onclick="fillLogin('npa_reporter','npa_reporter')">npa_reporter</button>
        <button class="btn" onclick="fillLogin('moh_reporter','moh_reporter')">moh_reporter</button>
        <button class="btn" onclick="fillLogin('zp_reporter','zp_reporter')">zp_reporter</button>
      </div>
    </div>
  </div>

  <div id="app" class="hidden">
    <div class="card bar">
      <div style="display:flex;gap:10px;align-items:center">
        <div id="avatar" class="pill" style="background:#111827;color:#fff"></div>
        <div>
          <div id="name" style="font-weight:700"></div>
          <div id="role" class="muted" style="color:#6b7280"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sec" onclick="openAdd()">âž• Add Record</button>
        <button class="btn btn-sec" onclick="exportCSV()">ðŸ“Š CSV</button>
        <button class="btn btn-sec" onclick="exportPDF()">ðŸ“„ PDF</button>
        <button class="btn btn-dan" onclick="logout()">ðŸšª Logout</button>
      </div>
    </div>

    <div class="card">
      <div class="bar">
        <b>Filters</b>
        <button class="btn" onclick="resetFilters()">Reset</button>
      </div>
      <div class="grid g4">
        <select id="fDistrict" onchange="applyFilters()">
          <option value="">All Districts</option>
          <option>Lusaka</option><option>Ndola</option><option>Kitwe</option>
        </select>
        <select id="fType" onchange="applyFilters()">
          <option value="">Record Type</option>
          <option>Victim</option><option>Witness</option>
        </select>
        <select id="fCrime" onchange="applyFilters()">
          <option value="">Crime Type</option>
          <option>Rape</option><option>Defilement</option><option>GBV</option>
        </select>
        <select id="fGender" onchange="applyFilters()">
          <option value="">Gender</option>
          <option>Male</option><option>Female</option>
        </select>
      </div>
      <div id="filterSummary" class="subtitle" style="margin-top:8px"></div>
    </div>

    <div class="grid g3" style="margin:12px 0">
      <div class="card"><div>Total Records</div><h2 id="kpiCount">0</h2></div>
      <div class="card"><div>Victims</div><h2 id="kpiVictims">0</h2></div>
      <div class="card"><div>Witnesses</div><h2 id="kpiWitnesses">0</h2></div>
    </div>

    <div class="grid g2">
      <div class="card"><canvas id="chart"></canvas></div>
      <div class="card">
        <div class="bar">
          <b>Records</b>
          <input id="search" placeholder="Search Case ID / District / Crimeâ€¦" oninput="applyFilters()" style="max-width:260px"/>
        </div>
        <table>
          <thead><tr><th>Case ID</th><th>District</th><th>Type</th><th>Crime</th><th>Gender</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="addModal" class="modal"><div class="sheet">
  <h3>Add Record</h3>
  <div class="grid g2" style="margin-top:10px">
    <input id="aCase" placeholder="Case ID (e.g., NPA-CV1)">
    <select id="aDistrict"><option>Lusaka</option><option>Ndola</option><option>Kitwe</option></select>
    <select id="aType"><option>Victim</option><option>Witness</option></select>
    <select id="aCrime"><option>Rape</option><option>Defilement</option><option>GBV</option></select>
    <select id="aGender"><option>Male</option><option>Female</option></select>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button class="btn" onclick="closeAdd()">Cancel</button>
    <button class="btn btn-pri" onclick="saveRecord()">Save</button>
  </div>
</div></div>

<div id="note" class="note"></div>

<script>
let currentUser=null;
const demoUsers={
  admin:{password:'admin123',role:'admin',name:'Administrator',avatar:'A'},
  viewer:{password:'view123',role:'viewer',name:'Data Viewer',avatar:'V'},
  reporter:{password:'report123',role:'reporter',name:'General Reporter',avatar:'R'},
  npa_reporter:{password:'npa_reporter',role:'reporter',name:'NPA Reporter',avatar:'N',agency:'NPA'},
  moh_reporter:{password:'moh_reporter',role:'reporter',name:'MOH Reporter',avatar:'M',agency:'MOH'},
  zp_reporter:{password:'zp_reporter',role:'reporter',name:'ZP Reporter',avatar:'Z',agency:'ZP'}
};

let records = JSON.parse(localStorage.getItem('records')||'[]');
let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue')||'[]');

function note(msg,type='success'){const n=document.getElementById('note');n.textContent=msg;n.className='note '+type;n.style.display='block';setTimeout(()=>n.style.display='none',3000);}
function $(id){return document.getElementById(id)}

async function loadUserProfile(uid){
  try{const doc=await db.collection('users').doc(uid).get();return doc.exists?doc.data():null}catch(e){return null}
}
window.handleLogin=function(){
  const u=$('username').value.trim(), p=$('password').value.trim(), err=$('loginError');
  if(!u||!p){err.style.display='block';err.textContent='Enter both fields';return}
  firebase.auth().signInWithEmailAndPassword(u+'@cvw.local',p)
   .then(cred=>loadUserProfile(cred.user.uid))
   .then(profile=>{
     if(profile){ currentUser=Object.assign({username:u,offline:false},profile); onLogin(); }
     else { note('User profile not found in Firestore','error'); }
   })
   .catch(()=>{
     if(demoUsers[u]?.password===p){ currentUser=Object.assign({username:u,offline:true},demoUsers[u]); onLogin(); }
     else { err.style.display='block'; err.textContent='Invalid credentials'; }
   });
};
window.fillLogin=function(u,p){$('username').value=u;$('password').value=p};

function onLogin(){
  $('login').classList.add('hidden'); $('app').classList.remove('hidden');
  $('avatar').textContent = currentUser.avatar||currentUser.name?.[0]||'?';
  $('name').textContent = currentUser.name||currentUser.username;
  $('role').textContent = (currentUser.role||'user') + (currentUser.offline?' Â· Offline':' Â· Online');
  render(); syncIfOnline();
}
function logout(){ if(confirm('Logout?')){ currentUser=null;$('app').classList.add('hidden');$('login').classList.remove('hidden');}}

const filter={district:'',type:'',crime:'',gender:'',q:''};
function applyFilters(){
  filter.district=$('fDistrict').value; filter.type=$('fType').value;
  filter.crime=$('fCrime').value; filter.gender=$('fGender').value;
  filter.q=($('search').value||'').toLowerCase(); render();
}
function resetFilters(){ $('fDistrict').value='';$('fType').value='';$('fCrime').value='';$('fGender').value='';$('search').value='';applyFilters()}

function openAdd(){ $('addModal').style.display='flex' }
function closeAdd(){ $('addModal').style.display='none' }
function saveRecord(){
  const r={
    id: $('aCase').value.trim()||('CASE-'+Date.now()),
    district: $('aDistrict').value, type: $('aType').value,
    crime: $('aCrime').value, gender: $('aGender').value,
    ts: Date.now(), owner: currentUser?.username||'unknown'
  };
  if(navigator.onLine && !currentUser?.offline){
    db.collection('cases').doc(r.id).set(r).then(()=>{
      records.push(r); persist(); render(); note('Record saved to Firestore','success');
    }).catch(err=>{
      offlineQueue.push({op:'upsert',type:'case',payload:r}); persist(); render(); note('Saved offline (write failed): '+err.message,'error');
    });
  }else{
    offlineQueue.push({op:'upsert',type:'case',payload:r}); records.push(r); persist(); render(); note('Saved offline; will sync later','warning');
  }
  closeAdd();
}
function persist(){ localStorage.setItem('records',JSON.stringify(records)); localStorage.setItem('offlineQueue',JSON.stringify(offlineQueue)); }

function syncIfOnline(){
  if(!(navigator.onLine && !currentUser?.offline)) return;
  if(!offlineQueue.length) return;
  const q=[...offlineQueue]; offlineQueue=[];
  const batch = db.batch();
  q.forEach(job=>{
    if(job.type==='case'&&job.op==='upsert'){
      const ref=db.collection('cases').doc(job.payload.id); batch.set(ref,job.payload,{merge:true});
    }
  });
  batch.commit().then(()=>{ persist(); note('Offline changes synced','success') })
  .catch(err=>{ offlineQueue=q; persist(); note('Sync failed: '+err.message,'error') });
}

let chartRef=null;
function render(){
  if(navigator.onLine && !currentUser?.offline){
    db.collection('cases').limit(200).get().then(snap=>{
      const server = snap.docs.map(d=>d.data());
      const map=new Map(records.map(r=>[r.id,r])); server.forEach(r=>map.set(r.id,r));
      records=[...map.values()]; persist(); draw();
    }).catch(draw);
  }else{ draw(); }
}
function draw(){
  let rows = records.filter(r=>
    (!filter.district||r.district===filter.district) &&
    (!filter.type||r.type===filter.type) &&
    (!filter.crime||r.crime===filter.crime) &&
    (!filter.gender||r.gender===filter.gender) &&
    (!filter.q||[r.id,r.district,r.crime,r.type,r.gender].join('|').toLowerCase().includes(filter.q))
  );
  document.getElementById('kpiCount').textContent = rows.length;
  document.getElementById('kpiVictims').textContent = rows.filter(r=>r.type==='Victim').length;
  document.getElementById('kpiWitnesses').textContent = rows.filter(r=>r.type==='Witness').length;
  document.getElementById('filterSummary').textContent = `Active: ${['district','type','crime','gender'].filter(k=>filter[k]).length} â€¢ Showing ${rows.length} / ${records.length}`;
  document.getElementById('rows').innerHTML = rows.map(r=>`<tr>
    <td>${r.id}</td><td>${r.district}</td><td>${r.type}</td><td>${r.crime}</td><td>${r.gender}</td>
  </tr>`).join('') || `<tr><td colspan="5" style="color:#6b7280">No data</td></tr>`;
  const byD={}; rows.forEach(r=>byD[r.district]=(byD[r.district]||0)+1);
  const labels=Object.keys(byD), data=Object.values(byD);
  const ctx=document.getElementById('chart'); if(chartRef) chartRef.destroy();
  chartRef=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Cases',data}]},options:{plugins:{legend:{display:false}}}});
}
function exportCSV(){
  const header=['Case ID','District','Type','Crime','Gender'];
  const csv=[header.join(',')].concat(records.map(r=>[r.id,r.district,r.type,r.crime,r.gender].join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='cvw_records.csv'; a.click(); URL.revokeObjectURL(url);
}
function exportPDF(){
  const { jsPDF } = window.jspdf; const doc = new jsPDF({orientation:'l',unit:'pt',format:'a4'});
  doc.setFontSize(16); doc.text('CVW Dashboard â€” Records Report', 40, 40);
  doc.setFontSize(10); doc.text(new Date().toLocaleString(), 40, 58);
  const rows = records.map(r=>[r.id,r.district,r.type,r.crime,r.gender]);
  doc.autoTable({startY:80, head:[['Case ID','District','Type','Crime','Gender']], body:rows, styles:{fontSize:9}});
  doc.save('cvw_records.pdf');
}
document.addEventListener('click',e=>{ if(e.target.id==='addModal') closeAdd() });
document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('username').focus() });
if(!records.length){
  records=[
    {id:'NPA-CV1',district:'Lusaka',type:'Victim',crime:'Defilement',gender:'Female',ts:Date.now()},
    {id:'NPA-CV2',district:'Ndola',type:'Witness',crime:'GBV',gender:'Male',ts:Date.now()},
    {id:'NPA-CV3',district:'Kitwe',type:'Victim',crime:'Rape',gender:'Female',ts:Date.now()}
  ];
  localStorage.setItem('records',JSON.stringify(records));
}
</script>
</body>
</html>
